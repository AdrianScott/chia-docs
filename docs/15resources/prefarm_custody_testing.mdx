---
id: prefarm_custody_testing
title: Prefarm Custody Testing
sidebar_label: Prefarm Custody Testing
sidebar_position: 8
---

```mdx-code-block
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
```

**This tutorial is meant for Chia employees only. **

This tutorial will show you how to use Chia's internal custody tool. Most of this tutorial requires using a command line interface.

There are two basic paths you can take for testing:
1. **[Install and run a custom testnet.](#install-and-run-a-custom-testnet)** You will be given the entire prefarm for this testnet. Yes, you will actually own 21 million (T)XCH!

  The _only_ reason to go with this option is if you need to test the custody solution with millions of TXCH. It's not really difficult to set up, but it does require a few extra steps.

2. **[Run on testnet10](#run-on-testnet10).** This requires fewer steps, but you won't be able to test with the entire prefarm.

This tutorial will go over both of these paths. It will also show you how to install the GitHub custody repository and run through a series of test cases.

Before continuing, you might want to familiarize yourself with the following documents:
* [Basic description](/docs/15resources/prefarm_custody_english) of how the custody tool works, in plain English
* [Flow chart](https://drive.google.com/file/d/1CvFOM59gA8Q-wwBNvPEuylWNYplPRG-1/view?usp=sharing) to visualize how the custody tool works

---

<details>
  <summary>Note about Python <code>RuntimeError</code> on Windows</summary>

If you are running on Windows, you might occasionally see a Python Runtime Error. This is a [known issue in Python](https://github.com/aio-libs/aiohttp/issues/4324 "More info about this issue") and can be safely ignored. For example:

```powershell
chia stop -d all

Exception ignored in: <function _ProactorBasePipeTransport.__del__ at 0x000001A719716160>
Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\proactor_events.py", line 116, in __del__
    self.close()
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\proactor_events.py", line 108, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\base_events.py", line 746, in call_soon
    self._check_closed()
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
daemon: {'ack': True, 'command': 'exit', 'data': {'success': True}, 'destination': 'client', 'origin': 'daemon', 'request_id': '0de5449121b6873ce18661b2adc4213d7dc795c2943ff7f4be9502058e8eaba0'}
```
</details>

---

## Install and run a custom testnet

:::info
If you want to run the custody tool on testnet10, you should skip this section and head to [the section for running on testnet10](#run-on-testnet10).
:::

Before you can create a custom testnet, you need to obtain a puzzle hash, which will hold the prefarm. This requires a few steps:

### Install Chia

In order to obtain a puzzle hash, Chia must be installed on your computer. It doesn't matter which version of Chia you have installed, as long as it's at least 1.3.0. You only need this version of Chia to obtain a puzzlehash

If Chia is already installed on your computer, then proceed to the next step.

If Chia is not already installed, run the appropriate installer from [chia.net/download/](https://www.chia.net/download/)

### Obtain a wallet address

:::warning important
You should create a new wallet that will only be used for testing the prefarm.
:::

**If you are running Chia's GUI:**
  1. Click "CREATE A NEW PRIVATE KEY"
    <figure>
      <img src="/img/custody/create_new_key.png" alt="Create a new key"/>
    </figure>
  2. You are recommended to copy the mnemonic (on paper or on your computer) for later recovery
  3. Click "NEXT"
    <figure>
      <img src="/img/custody/copy_seed.png" alt="Copy the mnemonic seed and click next"/>
    </figure>
  4. After a few seconds, you will be taken to your new wallet. Copy the number next to `Wallet` (on paper or on your computer). This is your wallet's fingerprint. You will need this number in a later step. Click `RECEIVE`
    <figure>
      <img src="/img/custody/fingerprint.png" alt="Copy the wallet fingerprint"/>
    </figure>
  5. You will be shown your wallet's primary receive address. Click the button to copy this address to your computer's clipboard. (It doesn't matter if it starts with XCH or TXCH)
    <figure>
      <img src="/img/custody/receive_address.png" alt="Copy the receive address"/>
    </figure>
  6. Proceed to the next step: [Obtain a puzzle hash](#obtain-a-puzzle-hash)

**If you are running from a CLI:**
  1. Run `chia keys generate`. For example:
    ```powershell
    (venv) PS C:\> chia keys generate
    Generating private key
    Added private key with public key fingerprint 1541183844
    ```
  2. Copy the fingerprint (on paper or on your computer)
  3. Run `chia keys show --show-mnemonic-seed`. For example:
    ```powershell
    (venv) PS C:\> chia keys show --show-mnemonic-seed
    Showing all public and private keys

    Fingerprint: 1541183844
    Master public key (m): b84dfc835480ccecd88839e6aec9b054da743b90a8cdc6617504e2adc881d00335ddddd4e722e3c0edf530c40c5a9650
    Farmer public key (m/12381/8444/0/0): 8657036a149034b91681c005fb4f322e7c4df987a1eaa1d426601c367bb01daad51934f9b60c482d687713b97aec3e9e
    Pool public key (m/12381/8444/1/0): a466c7f4f19cf8285d0de0a58caa2f7f740fc0a2409e32fabcfb4e122098b2cd8549ede63afa04688a84d01c70ac4470
    First wallet address: txch1hn6dxvhnrgnyg6yj20ry7yxzcnnlf2sh027s83u589kprf0fjfrs2unaad
    Master private key (m): 4eaceac1c3b49e015cf7a59bee3548f85030e9d4145f53195f2e79c29fa8759b
    First wallet secret key (m/12381/8444/2/0): <PrivateKey 38c2fa9c94d1f30c7706202ca08526a4f206550d2f4ad9f6a7c995c668c5318b>
    Mnemonic seed (24 secret words):
    coconut trick weapon sting faith physical resist message exercise decorate child ankle retire fresh boil human regret exile swear glimpse genius nominee nothing lab
    ```
  4. You are recommended to copy the 24-word mnemonic listed under the fingerprint you just generated, for later recovery. You can copy this on paper or on your computer
  5. Copy the address next to `First wallet address:` to your computer's clipboard. You'll use it in the next step. (It doesn't matter if it starts with `XCH` or `TXCH`)

---

### Obtain a puzzle hash

You should now have a Chia wallet address copied to your computer's clipboard.

The easiest way to obtain a puzzle hash is to use an online tool, such as the one available at [chia.tt/convert](https://chia.tt/convert).

Paste your wallet address into the "Address" field and you will automatically receive a puzzle hash:

<figure>
  <img src="/img/custody/address_to_puzzle_hash.png" alt="Address to puzzle hash converter"/>
</figure>

Copy this to your computer's clipboard, to be used in the next step.

:::info
What Chia calls a "puzzle hash" is the tree hash of the puzzle that can be run with your public/private key pair. This puzzle hash can then be encoded into a wallet address with any prefix, such as `xch` or `txch`. You have done the opposite in this step -- you have _decoded_ a wallet address back into the original puzzle hash. The resulting puzzle hash will be the same, regardless of the prefix of the wallet address. For this reason, it didn't matter if your wallet address started with `xch` or `txch`.
:::

---

### Create a custom testnet

In this step, you will a custom testnet, which you will use to test the internal custody solution. Per the previous step, you should have a puzzle hash copied to your computer's clipboard.

1. Visit the [GitHub workflow for generating a testnet](https://github.com/Chia-Network/testnet-config-generator/actions/workflows/make-testnet.yml)

  Click the "Run workflow" dropdown on the right side of the site. Fill in the following values:
  * Do not change `Branch: main`
  * In the text box under `The branch... to create the testnet from`, enter `latest`. (Technically you could use `main`, but there will be a higher chance of something being broken.)
  * In the text box under `The branch... with the testnet configuration`, enter `ictest-<your name>`. Remember the name you used
  * In the text box under `The network name to create...`, enter the same name you used in the previous text box (`ictest-<your name>`)
  * In the text box under `The puzzle hash the prefarm should go to`, paste your puzzle hash

  Here is an example screenshot:

<figure>
  <img src="/img/custody/workflow_create.png" alt="Workflow to create a testnet"/>
</figure>
<br/>

  Click the green `Run workflow` button. This will begin the process of creating the testnet. You'll be shown the message "Workflow run was successfully requested."

<figure>
  <img src="/img/custody/workflow_request_success.png" alt="Workflow request success"/>
</figure>
<br/>

  Click the workflow that is in progress (the red circle on the bottom right of the above screenshot). You'll be shown the status of this workflow. It should take less than two minutes to complete, after which the `Status` should say `Success`.

<figure>
  <img src="/img/custody/workflow_finished.png" alt="Workflow finished"/>
</figure>
<br/>

  Visit [https://github.com/Chia-Network/chia-blockchain/branches](https://github.com/Chia-Network/chia-blockchain/branches). You should see the branch your just created. This will automatically create a new testnet for you to use. The infrastructure to create this testnet is being run in the background.

<figure>
  <img src="/img/custody/github_new_branch.png" alt="New branch on GitHub"/>
</figure>
<br/>

This process requires about 30 minutes to complete.

You can continue with this tutorial in the meantime.

---

## Install your custom testnet

1. Stop your current installation of Chia

:::info
If you are unsure of how to run the commands from this step, you can reboot your computer and skip to step 2
:::

* If the wallet GUI is running, close it
* If you previously installed Chia using our packaged installer, then open a terminal (MacOS/Linux) or a Powershell window (Windows), and enter the following command:
  * Windows (be sure to replace `<username>` and `<version>` with the actual values): `C:\Users\<username>\AppData\Local\chia-blockchain\app-<version>\resources\app.asar.unpacked\daemon\chia.exe stop -d all`
  * MacOS: `/Applications/Chia.app/Contents/Resources/app.asar.unpacked/daemon/chia stop -d all`
  * Linux: [todo] 
* If you previously installed Chia from source, then activate a virtual environment and run `chia stop -d all`:

  ```powershell
  (venv) PS C:\> chia stop -d all
  Daemon not started yet
  Couldn't connect to chia daemon
  ```

  Make sure to deactivate your virtual environment before continuing:
  ```powershell
  (venv) PS C:\> deactivate
  PS C:\>
  ```

2. Make and `cd` to a new directory where you'll run your new Chia branch. You can name this directory whatever you want. This tutorial will call it `prefarm_test`:

  ```powershell
  PS C:\Users\User> mkdir prefarm_test

    Directory: C:\Users\User

  Mode                 LastWriteTime         Length Name
  ----                 -------------         ------ ----
  d----           5/23/2022  9:51 AM                prefarm_test

  PS C:\Users\User> cd prefarm_test
  PS C:\Users\User\prefarm_test>
  ```

3. Locally clone the branch you just created

  :::info
  If you don't already have the `git` CLI tool installed, [follow these instructions](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) to install it
  :::

  Run `git clone https://github.com/Chia-Network/chia-blockchain.git -b <branch name> --recurse-submodules`. 

  Be sure to replace `<branch name>` with actual branch name. The branch from this tutorial is called `ictest-dan_perry`. 

  This command should take less than 30 seconds to complete, depending on your internet connection.

  ```powershell
  (venv) PS C:\Users\User\prefarm_test> git clone https://github.com/Chia-Network/chia-blockchain.git -b ictest-dan_perry --recurse-submodules
  Cloning into 'chia-blockchain'...
  remote: Enumerating objects: 89238, done.
  remote: Counting objects: 100% (1572/1572), done.
  remote: Compressing objects: 100% (513/513), done.
  Receiving objects: 100% (89238/89238), 37.60 MiB | 10.06 MiB/s, done.ed 87666

  Resolving deltas: 100% (70645/70645), done.
  Submodule 'chia-blockchain-gui' (https://github.com/Chia-Network/chia-blockchain-gui.git) registered for path 'chia-blockchain-gui'
  Submodule 'mozilla-ca' (https://github.com/Chia-Network/mozilla-ca.git) registered for path 'mozilla-ca'
  Cloning into 'C:/Users/User/prefarm_test/chia-blockchain/chia-blockchain-gui'...
  remote: Enumerating objects: 48179, done.
  remote: Counting objects: 100% (3063/3063), done.
  remote: Compressing objects: 100% (919/919), done.
  remote: Total 48179 (delta 2173), reused 2801 (delta 1985), pack-reused 45116
  Receiving objects: 100% (48179/48179), 54.41 MiB | 16.78 MiB/s, done.
  Resolving deltas: 100% (31396/31396), done.
  Cloning into 'C:/Users/User/prefarm_test/chia-blockchain/mozilla-ca'...
  remote: Enumerating objects: 106, done.
  remote: Counting objects: 100% (17/17), done.
  remote: Compressing objects: 100% (6/6), done.
  remote: Total 106 (delta 13), reused 12 (delta 11), pack-reused 89
  Receiving objects: 100% (106/106), 284.67 KiB | 689.00 KiB/s, done.
  Resolving deltas: 100% (34/34), done.
  Submodule path 'chia-blockchain-gui': checked out '32245d869c70eedbb2a5fe77618b107dda70a647'
  Submodule path 'mozilla-ca': checked out '20338a00758970843652262219f4e0f639a6feed'
  ```

4. `cd` to the `chia-blockchain` directory and run the install script.
    
    * On Windows, this script is `Install.ps1`
    * On MacOS and linux, the script is `install.sh`

  This will take a few minutes to execute.

  ```powershell
  PS C:\Users\User\prefarm_test> cd .\chia-blockchain\
  PS C:\Users\User\prefarm_test\chia-blockchain>
  ```

  ```powershell
  PS C:\Users\User\prefarm_test\chia-blockchain> .\Install.ps1
  Python version is: 3.9.7
  Found Python with OpenSSL version:
  OpenSSL 1.1.1l  24 Aug 2021
  Anything before 1.1.1n is vulnerable to CVE-2022-0778.
  ...
  ...
  Chia blockchain .\Install.ps1 complete.
  For assistance join us on Keybase in the #support chat channel:
  https://keybase.io/team/chia_network.public

  Try the Quick Start Guide to running chia-blockchain:
  https://github.com/Chia-Network/chia-blockchain/wiki/Quick-Start-Guide

  To install the GUI type '.\Install-gui.ps1' after '.\venv\scripts\Activate.ps1'.

  Type '.\venv\Scripts\Activate.ps1' and then 'chia init' to begin.
  ```

5. Activate your virtual environment and initialize Chia

    * On windows, run `.\venv\Scripts\Activate.ps1`
    * On MacOS and Linux, run `. ./activate`
    * Regardless of OS, run `chia init`

  ```powershell
  PS C:\Users\User\prefarm_test\chia-blockchain> .\venv\Scripts\Activate.ps1
  (venv) PS C:\Users\User\prefarm_test\chia-blockchain> chia init
  Chia directory C:\Users\User\.chia\ictest-dan_perry
  Can't find private CA, creating a new one in C:\Users\User\.chia\ictest-dan_perry to generate TLS certificates
  Setting the xch destination for the farmer reward (1/8 plus fees, solo and pooling) to txch13amy3jfp8kkmqa87eswytj3a8ef22nm8zwsf3ckptpm8rv72qtgqgvk6fs
  Setting the xch destination address for pool reward (7/8 for solo only) to txch13amy3jfp8kkmqa87eswytj3a8ef22nm8zwsf3ckptpm8rv72qtgqgvk6fs
  To change the XCH destination addresses, edit the `xch_target_address` entries in C:\Users\User\.chia\ictest-dan_perry\config\config.yaml.

  To see your keys, run 'chia keys show --show-mnemonic-seed'
  ```

6. Connect to your testnet blockchain

  Run `chia start farmer`. This will start all of the required processes for running the custody tool.

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\chia-blockchain\chia-blockchain-gui> chia start farmer
  chia_harvester: started
  chia_farmer: started
  chia_full_node: started
  chia_wallet: started
  ```

7. Check the status of your testnet

  Run `chia show -s`. This will show the status of the network. 
  The timelord and farmer required to run the network were created and started automatically when you created the branch in the previous step. 

  It takes around 30 minutes for the first block to be created. However, it could take longer for you to start seeing the blocks. It took around 4 hours during one test run for this tutorial.

  If you receive this message: `Blockchain has no blocks yet`, then try the same command again later.

  For example:

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\chia-blockchain> chia show -s
  Network: ictest-dan_perry    Port: 58445   RPC Port: 8555
  Node ID: f40100b8b46550eb75b79edab4de38611eb543ac8975e262c2d2bf1e1c594312
  Genesis Challenge: 0b101cde014326bce48f030553bab0c4d430dfdbd0aeb9302b0fe85ca1b251ab

  Searching for an initial chain

  You may be able to expedite with 'chia show -a host:port' using a known node.

  Blockchain has no blocks yet
  ```

  Once new blocks are being added, you will receive this message: `Current Blockchain Status: Full Node Synced`:

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\chia-blockchain\chia-blockchain-gui> chia show -s
  Network: ictest-dan_perry    Port: 58445   RPC Port: 8555
  Node ID: f40100b8b46550eb75b79edab4de38611eb543ac8975e262c2d2bf1e1c594312
  Genesis Challenge: 0b101cde014326bce48f030553bab0c4d430dfdbd0aeb9302b0fe85ca1b251ab
  Current Blockchain Status: Full Node Synced

  Peak: Hash: f4d7056d832f1cd3b359421ab74a87177804b605dc8a9a0df5c6bd3210e0a950
        Time: Mon May 23 2022 12:09:51 China Standard Time                  Height:        904

  Estimated network space: 48.902 GiB
  Current difficulty: 29
  Current VDF sub_slot_iters: 71303168
  Total iterations since the start of the blockchain: 2041687603

    Height: |   Hash:
        904 | f4d7056d832f1cd3b359421ab74a87177804b605dc8a9a0df5c6bd3210e0a950
        903 | e9eec6068356c2897863926f1c0a6e21af738ec7fb573472bb8bcd1dec9f48ae
        902 | 6fb79196dea5d9c8ba6f3896b5a39902839bc4c60784190886866431ef93b5da
        901 | 962f3cf610c0e1dd8ee47206efd2fee1ad1c1b7d7f96a9f598ef889e0d24641c
        900 | 17d0e231a67a6e560727096983aff3617c50bcb0e79fd53a376a5a48bc352d42
        899 | fb46c9908260a7127f45a4a67aa4fa954c7aa1f3b625075887e0df2425c2f6ce
        898 | bdf250bc7e22bb16e53126bcf09acaa40b3aefe47b1839934d50d5e1d872ff61
        897 | 0e90c6f2cacea7e45cc0b50f7c8436d32da572731b2f435fb5291adde156a2e8
        896 | 20ac76cab956f521195c52a43453c42eeeca3dd3d6cb9e952484c1b55669bea7
        895 | 418c507e7908953389d8e66a5274db4a18337dcd0e3f09e84e12241584b2e991
  ```

  You can verify that you have those cool 21 million TXCH by running `chia wallet show` and selecting the wallet from which you obtained the puzzle hash earlier:

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\chia-blockchain> chia wallet show
  Wallet keys:
  1)   502984008
  2) * 2447771420 (Synced)
  Choose a wallet key [1-2] ('q' to quit, or Enter to use 2447771420):
  Wallet height: 10026
  Sync status: Synced
  Balances, fingerprint: 2447771420

  Chia Wallet:
     -Total Balance:         21000000.0 txch (21000000000000000000 mojo)
     -Pending Total Balance: 21000000.0 txch (21000000000000000000 mojo)
     -Spendable:             21000000.0 txch (21000000000000000000 mojo)
     -Type:                  STANDARD_WALLET
     -Wallet ID:             1

  Connections:
  Type      IP                                     Ports       NodeID      Last Connect      MiB Up|Dwn
  FULL_NODE 127.0.0.1                              58445/58445 f40100b8... May 25 09:58:36      0.0|0.0
                                                 -Height: No Info    -Hash: No Info    -Trusted: True
  ```

  If your wallet does not show a balance of 21000000.0 txch, then something is wrong. Verify that the puzzle hash of your personal testnet was entered correctly and that you are looking at the correct.

#### You still have to do one thing before continuing.

:::warning important

Your custom testnet has created a new folder called `~\.chia\ictest-<your name>`. 
However, the custody tool will automatically use a version of Chia that expects this folder to be called `~\.chia\mainnet`. To avoid issues later, do the following:

1. Rename the `~\.chia\mainnet` folder to something like `~\.chia\mainnet_bak`
2. Copy the `~\.chia\ictest-<your name>` folder and all of its contents to a new folder called `~\.chia\mainnet`

You should now have three folders in `~\.chia`, where `mainnet` is actually a copy of `~\.chia\ictest-<your name>`.

For example:
```powershell
(venv) PS C:\Users\User> ls ~/.chia

    Directory: C:\Users\User\.chia

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d----           5/23/2022 10:39 AM                ictest-dan_perry
d----           5/23/2022  9:39 PM                mainnet
d----           5/12/2022 11:34 AM                mainnet_bak
```

:::

Note that your new testnet will create a new folder called `~\.chia\ictest-<your name>`. 
This folder will hold your databases and logs for this testnet.

You can skip the next section, which will show you how to run on testnet10 instead of a custom testnet.

Instead, proceed to following section, [installing the custody tool](#install-the-custody-tool).

---

## Run on testnet10

If you plan to run the custody tool on testnet10 (as opposed to running it on a custom testnet), then you'll need to do five steps before proceeding:
1. Install Chia from source
2. Change your configuration to use the testnet
3. Add a new wallet
4. Add some TXCH to your wallet
5. Sync your node

If you have already done these steps, then proceed to the next section, [installing the custody tool](#install-the-custody-tool). If not, then you're in the right place.

### Install Chia from source

This section will show you how to download and install Chia from the `latest` branch.

:::tip
Your firewall might give warnings when installing Chia. This is normal. Allow the installations to continue.
:::

Before doing anything else, you can begin to download a copy of the testnet10 blockchain database. [Click here to begin the download.](https://download.chia.net/testnet10/blockchain_v2_testnet10.sqlite.gz "Chia's testnet10 database download site") Save the file to your Downloads folder.

:::note
The file you will download is around 15 GB, compressed. Uncompressed, it will be around 30 GB. Make sure you have at least this much free space, and ideally 50 GB.
:::

You may continue with the next steps while the download is in progress.

#### Stop your current installation of Chia

:::info
If you are unsure of how to run the commands from this step, you can reboot your computer and proceed to 
:::

* If the wallet GUI is running, close it
* If you previously installed Chia using our packaged installer, then open a terminal (MacOS/Linux) or a Powershell window (Windows), and enter the following command:
  * Windows (be sure to replace `<username>` and `<version>` with the actual values): `C:\Users\<username>\AppData\Local\chia-blockchain\app-<version>\resources\app.asar.unpacked\daemon\chia.exe stop -d all`
  * MacOS: `/Applications/Chia.app/Contents/Resources/app.asar.unpacked/daemon/chia stop -d all`
  * Linux: [todo] 
* If you previously installed Chia from source, then activate a virtual environment and run `chia stop -d all`:

```powershell
(venv) PS C:\> chia stop -d all
Daemon not started yet
Couldn't connect to chia daemon
```

Make sure to deactivate your virtual environment before continuing:
```powershell
(venv) PS C:\> deactivate
PS C:\>
```

#### Clone and install Chia

In this step you will use the git CLI tool to clone the `latest` branch of the `chia-blockchain` repository, as well as install Chia.

:::note
If you don't already have the `git` CLI tool installed, [follow these instructions](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) to install it
:::

In this step you will use the git CLI tool to clone the `latest` branch of the `chia-blockchain` repository, as well as install Chia.

First, make and `cd` to a new directory where you'll run Chia. You can name this directory whatever you want. This tutorial will call it `prefarm_test`:

  ```powershell
  PS C:\Users\User> mkdir prefarm_test

    Directory: C:\Users\User

  Mode                 LastWriteTime         Length Name
  ----                 -------------         ------ ----
  d----           5/23/2022  9:51 AM                prefarm_test

  PS C:\Users\User> cd prefarm_test
  PS C:\Users\User\prefarm_test>
  ```

Locally clone the branch you just created

:::info
If you don't already have the `git` CLI tool installed, [follow these instructions](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) to install it
:::

Run `git clone https://github.com/Chia-Network/chia-blockchain.git -b latest --recurse-submodules`. 

This command should take less than 30 seconds to complete, depending on your internet connection.

```powershell
(venv) PS C:\Users\User\prefarm_test> git clone https://github.com/Chia-Network/chia-blockchain.git -b latest --recurse-submodules
Cloning into 'chia-blockchain'...
remote: Enumerating objects: 89238, done.
remote: Counting objects: 100% (1572/1572), done.
remote: Compressing objects: 100% (513/513), done.
Receiving objects: 100% (89238/89238), 37.60 MiB | 10.06 MiB/s, done.ed 87666

Resolving deltas: 100% (70645/70645), done.
Submodule 'chia-blockchain-gui' (https://github.com/Chia-Network/chia-blockchain-gui.git) registered for path 'chia-blockchain-gui'
Submodule 'mozilla-ca' (https://github.com/Chia-Network/mozilla-ca.git) registered for path 'mozilla-ca'
Cloning into 'C:/Users/User/prefarm_test/chia-blockchain/chia-blockchain-gui'...
remote: Enumerating objects: 48179, done.
remote: Counting objects: 100% (3063/3063), done.
remote: Compressing objects: 100% (919/919), done.
remote: Total 48179 (delta 2173), reused 2801 (delta 1985), pack-reused 45116
Receiving objects: 100% (48179/48179), 54.41 MiB | 16.78 MiB/s, done.
Resolving deltas: 100% (31396/31396), done.
Cloning into 'C:/Users/User/prefarm_test/chia-blockchain/mozilla-ca'...
remote: Enumerating objects: 106, done.
remote: Counting objects: 100% (17/17), done.
remote: Compressing objects: 100% (6/6), done.
remote: Total 106 (delta 13), reused 12 (delta 11), pack-reused 89
Receiving objects: 100% (106/106), 284.67 KiB | 689.00 KiB/s, done.
Resolving deltas: 100% (34/34), done.
Submodule path 'chia-blockchain-gui': checked out '32245d869c70eedbb2a5fe77618b107dda70a647'
Submodule path 'mozilla-ca': checked out '20338a00758970843652262219f4e0f639a6feed'
```
  
Install Chia:
  ```mdx-code-block
  <Tabs
    defaultValue="windows"
    values={[
      {label: 'Windows', value: 'windows'},
      {label: 'Linux/macOS', value: 'nix'},
    ]}>
    <TabItem value="windows">
  ```
  ```powershell
  cd chia-blockchain
  .\Install.ps1
  .\venv\Scripts\Activate.ps1
  chia init
  ```
  ```mdx-code-block
    </TabItem>
    <TabItem value="nix">
  ```
  ```bash
  cd chia-blockchain
  sh install.sh
  . ./activate
  chia init
  ```
  ```mdx-code-block
    </TabItem>
  </Tabs>
  ```

:::tip
If you receive the message `WARNING: UNPROTECTED SSL FILE!` then run:
```powershell
chia init --fix-ssl-permissions
```
:::

#### Change your configuration to use the testnet

Run the following command to set up Chia to use the testnet:
```bash
chia configure --testnet true
```

#### Add a new key pair

You should a public/private key pair specifically for testing the custody tool. Here's how to generate one:

```bash
chia keys generate
```

This will give an output such as the following:
```bash
Generating private key
Added private key with public key fingerprint 3049838316
(...)
```

  You are recommended to write down your seed phrase for later recovery. Run the following: 

  ```bash
  chia keys show --show-mnemonic-seed
  ```

  You'll be shown your public and private keys. The last line of the output will be a list of 24 secret words. This is your _seed phrase_. **Carefully copy the words on paper and store them in a secure location.** Order is important.
  ```text
  Showing all public and private keys

  Fingerprint: 3049838316
  (...)
	Mnemonic seed (24 secret words):
  // highlight-next-line
  youth stomach social aware clay pottery benefit asthma mail cry rubber panda wife around provide atom cute sand staff exotic pink east gloom minute
  ```

#### Start and sync your wallet

First, start your wallet by running:

  ```bash
  chia start wallet
  ```

Next, wait for your wallet to sync. You can view the status of your wallet with the following command:

  ```bash
  chia wallet show
  ```

  Be sure to select the correct key/fingerprint, which you obtained from the `chia keys show` command:

  ```text
  Wallet keys:
  1)   285637561
  2) * 3049838316 (Not Synced)
  Choose a wallet key [1-2] ('q' to quit, or Enter to use 3049838316):
  Wallet height: 938814
  Sync status: Syncing...
  ```

  Syncing should only require a few minutes, unless your wallet has a large number of previous transactions. Eventually, the `chia wallet show` command will show that your wallet has been synced:

  ```text
  Wallet height: 938990
  Sync status: Synced
  Balances, fingerprint: 3049838316

  Chia Wallet:
     -Total Balance:         14.5 txch (14500000000000 mojo)
     -Pending Total Balance: 14.5 txch (14500000000000 mojo)
     -Spendable:             14.5 txch (14500000000000 mojo)
     -Type:                  STANDARD_WALLET
     -Wallet ID:             1
  ```

#### Add some TXCH to your wallet

In order to run the custody tool, you'll need to have some TXCH in your wallet. If your total balance is 0, you can obtain 1 TXCH from our faucet. Copy the value of "First wallet address:" from the output of the `chia keys show` command. It will be a long string beginning with "txch". 

  Open our [testnet faucet page](https://testnet10-faucet.chia.net "Chia's testnet10 faucet link"). Paste your address and click "Submit".

  You'll receive this message: `Accepted. Your request is in the queue and will be processed in the order it was received.` At some point you'll receive 1 TXCH. Depending on how busy the faucet and the testnet are, this could take several minutes. However, you don't need to wait for your coins to arrive before continuing.

#### Sync your node

1. Create the folder where your database will reside:

	```bash
	mkdir ~/.chia/mainnet/db
	```

2. You must wait for your database file to finish downloading before continuing. After the download has completed, use an archive manager such as [7-Zip](https://www.7-zip.org/ "7-Zip's website") to extract the file. You should now have a file in your Downloads folder called `blockchain_v2_testnet10.sqlite`.

 Move the database to the folder you just created:
 ```bash
 mv ~/Downloads/blockchain_v2_testnet10.sqlite ~/.chia/mainnet/db
 ```

3. Start the full node, which will begin syncing to the database file:

  ```bash
  (venv) $ chia start node
  chia_full_node: started
  ```

4. Check the sync status:

  ```bash
  chia show -s
  ```

  Eventually, it will say `Full Node Synced`:
  ```text
  Network: testnet10    Port: 58444   RPC Port: 8555
  Node ID: 82a73b06b3a5f9493a3ac4e3d903026b39c85b748158ba41c623d531947f2a2a
  Genesis Challenge: ae83525ba8d1dd3f09b277de18ca3e43fc0af20d20c4b3e92ef2a48bd291ccb2
  // highlight-next-line
  Current Blockchain Status: Full Node Synced
  ```

Once you have a synced full node and some TXCH, you may proceed to the next section. If your requested TXCH has not yet arrived, post your address on the #dogfooding channel on Keybase. Someone might be able to send some to you.

---

## Install the custody tool

Requirements:
* Windows or Linux (not tested on MacOS)
* Synced Chia testnet (either testnet10 or custom)
* A wallet with some TXCH
* Python 3.9 or greater (will not work with 3.8.x)
* Git command line tool
* Powershell 6 or greater (Windows only)

### Steps to install

1. Open a new Powershell/terminal window and `cd` to the directory in which you previously cloned Chia. In this tutorial, this directory will be `prefarm_test`

  ```powershell
  PS C:\Users\User> cd prefarm_test
  PS C:\Users\User\prefarm_test> ls

      Directory: C:\Users\User\prefarm_test

  Mode                 LastWriteTime         Length Name
  ----                 -------------         ------ ----
  d----           5/23/2022  4:13 PM                chia-blockchain
  ```

2. Clone the internal custody repository by running `git clone https://github.com/Chia-Network/internal-custody.git`

  ```powershell  
  PS C:\Users\User\prefarm_test> git clone https://github.com/Chia-Network/internal-custody.git
  Cloning into 'internal-custody'...
  remote: Enumerating objects: 554, done.
  remote: Counting objects: 100% (176/176), done.
  remote: Compressing objects: 100% (73/73), done.

  Receiving objects: 100% (554/554), 167.28 KiB | 2.01 MiB/s, done.
  Resolving deltas: 100% (325/325), done.
  ```

3. Change to the new repo dir by running `cd internal-custody`

  ```powershell
  PS C:\Users\User\prefarm_test> cd internal-custody
  PS C:\Users\User\prefarm_test\internal-custody>
  ```

4. Create a virtual environment by running `py -m venv venv`

  ```powershell
  PS C:\Users\User\prefarm_test\internal-custody> py -m venv venv
  PS C:\Users\User\prefarm_test\internal-custody>
  ```

5. Activate your virtual environment by running:
    * `. ./venv/bin/activate` (if Linux or MacOS)
    * `.\venv\Scripts\activate` (if Windows)

  ```powershell
  PS C:\Users\User\prefarm_test\internal-custody> .\venv\Scripts\activate
  (venv) PS C:\Users\User\prefarm_test\internal-custody>
  ```

  You should now see `(venv)` on the left side of your command prompt.

6. Install the custody tool
    * First, run `pip install .` (This will take a few minutes to complete)
    * Next, run `pip install git+https://github.com/Chia-Network/hsms.git@main#1c6122bebf482e8ee777f5c401eb16ac2ffca68c`
    * If you are on Windows, run `pip install pyreadline`

  Note that you may receive pip warning and/or dependency errors for blspy and/or clvm-tools-rs (see example below). These can be safely ignored.

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\internal-custody> pip install .
  Processing c:\users\user\prefarm_test\internal-custody
    Installing build dependencies ... done
    Getting requirements to build wheel ... done
  ...
    Successfully built chia-internal-custody chia-blockchain
  Installing collected packages: pycparser, zipp, pybind11, cffi, pywin32-ctypes, pywin32, multidict, importlib-metadata, idna, frozenlist, blspy, argon2-cffi-bindings, yarl, typing-extensions, six, pyparsing, pycryptodome, portalocker, keyring, colorama, clvm, charset-normalizer, attrs, async-timeout, argon2-cffi, aiosignal, zstd, watchdog, sortedcontainers, setproctitle, PyYAML, packaging, keyrings.cryptfile, filelock, fasteners, dnspythonchia, dnslib, cryptography, concurrent-log-handler, colorlog, clvm-tools-rs, clvm-tools, click, chiavdf, chiapos, chiabip158, chia-rs, bitstring, aiosqlite, aiohttp, aiofiles, segno, chia-blockchain, chia-internal-custody
      Running setup.py install for zstd ... done
  Successfully installed PyYAML-6.0 
  ...
  ```

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\internal-custody> pip install git+https://github.com/Chia-Network/hsms.git@main#1c6122bebf482e8ee777f5c401eb16ac2ffca68c
  Collecting git+https://github.com/Chia-Network/hsms.git@main#1c6122bebf482e8ee777f5c401eb16ac2ffca68c
  ...
    Attempting uninstall: blspy
      Found existing installation: blspy 1.0.13
      Uninstalling blspy-1.0.13:
        Successfully uninstalled blspy-1.0.13
    Attempting uninstall: clvm-tools-rs
      Found existing installation: clvm-tools-rs 0.1.9
      Uninstalling clvm-tools-rs-0.1.9:
        Successfully uninstalled clvm-tools-rs-0.1.9
  ERROR: pips dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
  chia-blockchain 1.3.6.dev143 requires blspy==1.0.13, but you have blspy 1.0.9 which is incompatible.
  chia-blockchain 1.3.6.dev143 requires clvm-tools-rs==0.1.9, but you have clvm-tools-rs 0.1.7 which is incompatible.
  Successfully installed blspy-1.0.9 clvm-tools-rs-0.1.7 hsms-0.1.dev79
  WARNING: You are using pip version 21.2.3; however, version 22.1.1 is available.
  You should consider upgrading via the 'C:\Users\User\prefarm_test\internal-custody\venv\Scripts\python.exe -m pip install --upgrade pip' command.
  ```

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\internal-custody> pip install pyreadline
  Collecting pyreadline
    Downloading pyreadline-2.1.zip (109 kB)
       |████████████████████████████████| 109 kB 6.8 MB/s
  Using legacy 'setup.py install' for pyreadline, since package 'wheel' is not installed.
  Installing collected packages: pyreadline
      Running setup.py install for pyreadline ... done
  Successfully installed pyreadline-2.1
  ```

7. Test your installation

  The Chia Internal Custody (cic) tool should be installed. 
  To verify this, run `cic --help`. 
  You should get a usage statement.

  ```powershell
  (venv) PS C:\Users\User\prefarm_test\internal-custody> cic --help
  Usage: cic [OPTIONS] COMMAND [ARGS]...

    Commands to control a prefarm singleton
  ...
  ```

---

## Initialize a singleton

The prefarm's custody solution is a Chialisp singleton. 
This section will show you how to set up this singleton for testing.

:::note
Regarding the HSMs:
* Some commands are meant to be run from inside a Hardware Security Module or "vault"
* This is a physical/offline security solution for generating and signing keys
* Commands to be run inside the vault are labeled as such

Regarding the blockchain:
* Most of the commands from this tutorial will not alter the blockchain
* Commands that will alter the blockchain are labeled as such
:::

### Create a file with immutable info

* This command will **not** modify the blockchain. It will only create a local file
* This command should be run from **outside** the vault

The `cic init` command will initialize the public configuration of the singleton. **None** of this command's arguments may be changed later.

The following table lists the arguments for this command that will be used in this tutorial, as well as their equivalent notations in the [flow chart](https://drive.google.com/file/d/1CvFOM59gA8Q-wwBNvPEuylWNYplPRG-1/view?usp=sharing):

Flag         |Flow Chart<br/>Equivalent | Tutorial<br/>Value            | Prefarm<br/>Value | Description
:------------|:-------------------------|:-----------------------------|:------------------|:-----------
`--directory`| N/A                      | keys_and_sb                  | Unknown           | The directory where all of the keys and spend bundles will be stored.
`--date`     | N/A                      | 1653449948                   | Unknown           | The [UNIX epoch timestamp](https://www.epochconverter.com/) when the singleton's "amount available" setting will begin to increase. For testing, you can set it to a time in the near future (for example, 100 seconds from now).
`-r`         | Max Withdrawal Amount    | 10^13 mojos (10 XCH)         | Billions of mojos | The number of mojos per second you want to be made available to be withdrawn.
`-a`         | N/A                      | 10^19 mojos (10 million XCH) | Millions of XCH   | The total size of the singleton. This example uses 1 million mojos. The prefarm will set this to some millions of XCH.
`-wt`        | `W`                      | 600 seconds                  | 30 days           | Withdrawal Timelock -- When attempting to begin a withdrawal, this is the minimum number of seconds that must have elapsed since the last withdrawal, rekey or claw back.
`-pc`        | `D`                      | 1200 seconds                 | 90 days           | Payment Claw back -- The minimum number of seconds that must elapse after initiating a withdrawal before the withdrawal can be completed. Claw backs are possible during this window.
`-rt`        | `T`                      | 300 seconds                  | 15 days           | Rekey Timelock -- When attempting to begin a standard rekey, this is the minimum number of seconds that must have elapsed since the last withdrawal, rekey or claw back. For a slow rekey, this amount gets added for each key less than `m`.
`-rc`        | `D'`                     | 600 seconds                  | 30 days           | Rekey Claw back -- The minimum number of seconds that must elapse after initiating a rekey before the rekey can be completed. Claw backs are possible during this window.
`-sp`        | `P`                      | 900 seconds                  | 45 days           | Slow rekey Penalty -- This amount gets added to the Rekey Timelock when a slow rekey is being performed.

:::info note regarding the above table
* With the exception of `--date`, singleton's time values are relative to when they're confirmed on chain
* The specific time values for this example were chosen to give adequate time to run certain tests where withdrawals and rekeys are attempted before they are allowed. Feel free to shorten or lengthen these times as your own testing requires. Unfortunately, you won't be able to change any of these values later, unless you start over with a new singleton
* The values for `-r` and `-a` assume you're using a custom testnet and possess 21 million TXCH. It will allow the entire singleton (10 million TXCH) to be withdrawn after 1 million seconds (~11.5 days). If you are running on testnet10, you could choose values such as `-r 1` and `-a 1000000` (1 million) to achieve the same timeline, but on a much smaller monetary scale
* Be sure to update `--date` to a timestamp in the near future (200 seconds from now is probably fine). You can get the current timestamp from [this website](https://www.epochconverter.com/)
:::

First, create and `cd` to the directory that will be specified by the `--directory` flag:

```powershell
(venv) PS C:\Users\User\prefarm_test> mkdir keys_and_sb

    Directory: C:\Users\User\prefarm_test

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d----           5/23/2022  2:55 PM                keys_and_sb

(venv) PS C:\Users\User\prefarm_test> cd keys_and_sb
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

Next, run the command to initialize the singleton:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic init --directory C:\Users\User\prefarm_test\keys_and_sb --date 1653449948 -r 10000000000000 -a 10000000000000000000 -wt 600 -pc 1200 -rt 300 -rc 600 -sp 900
Created a configuration file: C:\Users\User\prefarm_test\keys_and_sb\Configuration (needs derivation).txt
```

As a result of running the `init` command, a binary file called `Configuration (needs derivation).txt` will be created in the `--directory` location.

This file only contains the immutable values of the singleton, so it can be sent out to observer nodes.
If you wish to send it out, you should make a copy of it now because it will be modified during the derivation step.

---

### Generate keys

* These commands will **not** modify the blockchain. They will only create local files
* These commands should be run from **inside** the vault

Note that the secret exponents (private keys, contained within .se files) must be created before the singleton can be launched.

For this example:
* `m` will initially be set to 2. This is security level, or "lock level" of the singleton. In other words, it's the number of keys required to sign for withdrawals and standard rekeys
* `n` will initially be set to 3. This is the maximum lock level of the singleton. In other words, it the total number of keys that will be associated with the singleton

The `hsmgen` command will generate a secret exponent and output it to the command line. However, we want to save it to a file, so use the `>` key to redirect the output, like this: `hsmgen > 1.se`.

You'll need to run the command 3 times (one for each key), redirecting to different .se files each time:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmgen > 1.se
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmgen > 2.se
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmgen > 3.se
```

Next, use the `hsmpk` command to derive a public key from each of the secret exponents:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmpk $(cat .\1.se) > 1.pk
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmpk $(cat .\2.se) > 2.pk
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmpk $(cat .\3.se) > 3.pk
```

As a result of running this command, a public key will be added to a new text file, which can be removed from the vault to be used in the next command.

Your current directory should now contain 3 public keys (`.pk`), 3 private keys (`.se`), and `Configuration (needs derivation).txt`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> ls

    Directory: C:\Users\User\prefarm_test\keys_and_sb

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a---           5/23/2022  3:25 PM             93 1.pk
-a---           5/23/2022  3:24 PM             63 1.se
-a---           5/23/2022  3:26 PM             93 2.pk
-a---           5/23/2022  3:24 PM             63 2.se
-a---           5/23/2022  3:26 PM             93 3.pk
-a---           5/23/2022  3:24 PM             63 3.se
-a---           5/23/2022  3:01 PM            128 Configuration (needs derivation).txt
```

---

### Derive puzzles

* This command will **not** modify the blockchain. It will only create a local file
* This command should be run from **outside** the vault

This command will derive the puzzles for the public keys.

It sets up the non-permanent settings:
* `m` (current lock level)
* `n` (maximum lock level)
* The public keys that comprise `n`, expressed as a comma-separated list

If this command is run without the optional `--configuration` flag, it will look for the configuration file in the default location of `./Configuration (needs derivation).txt`.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic derive_root -pks "1.pk,2.pk,3.pk" -m 2 -n 3
Custody rules successfully added to configuration
```

As a result of running this command, `Configuration (awaiting launch).txt` will be created.

---

### Launch Singleton

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

In this step, you will run `cic launch_singleton`, which will create the singleton on the blockchain.

If this command is run without the optional `--configuration` flag, it will look for the configuration file in the default location of `./Configuration (awaiting launch).txt`. 

Because this command modifies the blockchain, a synced wallet is required to run it. To be sure your wallet is still synced, you can run `chia show -s` and look for `Current Blockchain Status: Full Node Synced` on the fourth line of the response.

The singleton will **not** be funded after running this command. It will have zero value until another command is run (explained later).

The mempool won't be full on your custom testnet, so there's no need to include a fee. (If you want to test using a fee, the flag is `--fee <mojos>`)

You must choose one wallet from which to withdraw the money. It must have at least 1 mojo to create the singleton. Note that the wallet keys will eventually be displayed in an easier-to-discern form, such as the owner's name, instead of a number.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic launch_singleton
Wallet keys:
1)   502984008
2) * 2447771420 (Synced)
Choose a wallet key [1-2] ('q' to quit, or Enter to use 2447771420):
Singleton successfully launched
```

Congratulations, you have successfully launched the singleton! (You'll need to wait for the next transaction block before it's added to the blockchain.) As a result of running this command, the configuration file's name has changed to `Configuration (xxxxxx).txt`, where `xxxxxx` is a hexadecimal value. For example:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> ls

    Directory: C:\Users\User\prefarm_test\keys_and_sb

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a---           5/25/2022 11:37 AM             93 1.pk
-a---           5/25/2022 11:37 AM             63 1.se
-a---           5/25/2022 11:37 AM             93 2.pk
-a---           5/25/2022 11:37 AM             63 2.se
-a---           5/25/2022 11:37 AM             93 3.pk
-a---           5/25/2022 11:37 AM             63 3.se
-a---           5/25/2022 11:39 AM           1209 Configuration (f71aa1).txt
```

:::important
If you receive an error stating the Chia is not running, then you need to modify your configuration folder's structure. See [the above warning](#you-still-have-to-do-one-thing-before-continuing) for more info.
:::

---

### Show the singleton

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

At this point, the singleton should exist on the blockchain. However, it has not yet been funded -- you've indicated the amount to fund it with, but you haven't actually sent the money to it yet. We'll do that in the next step.

But first, let's view it. In order to do this, you must first synchronize the localhost with the blockchain.
The first time you run the `sync` command, you'll need to specify the configuration file, which will then be copied into your config database.

The command to do this is `cic sync -c '.\Configuration (<hex value>).txt'`. Be sure to replace `<hex value>` with the actual value from your configuration file, and make sure to put quotes around the file name because it contains spaces.

For example:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync -c 'Configuration (f71aa1).txt'
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

This command does not produce any output. From now on, you don't need to specify the config file to synchronize your host with the blockchain.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

In order to view the singleton's status (with optional config details), run `cic show -c`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -c

Current time: 1653451439 (05/25/2022, 12:03:59)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 0
  - amount available: -9985090000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
  REKEYS:

Config:
 - started: 05/25/2022, 11:39:08
 - initial amount: 10000000000000000000
 - mojos available per second: 10000000000000
 - current root: f71aa173dc57c4a1e77d5386d5c6b9ece1df82b95139af3c26d123fa4d662103
 - withdrawal timelock: 600 seconds
 - payment clawback period: 1200 seconds
 - rekey cancellation period: 600 seconds
 ```

Here's how to interpret this output:

* Singleton:
  * `launcher ID`: This shows the on-chain ID of your singleton
  * `amount left`: This is the current value of the singleton. For now it is zero because it has not yet been funded
  * `amount available`: This is the number of mojos that may be withdrawn. This number is negative because it has not yet been funded. 
  
    After it is funded (explained later), it will correctly display the amount available to be withdrawn. Note that the singleton can absorb payments made to it, as well as make payments to others. If desired, it can do both of these things within the same block
  * `amount to claim`: This is the number of mojos currently in the process of being withdrawn (aka in a drop coin). The money is effectively sitting in escrow, and will be able to be withdrawn after the withdrawal timelock has been fulfilled

* Outstanding events:
  * `PAYMENTS`: If there were a payment in progress, it would be shown here
  * `REKEYS`: If there were a rekey in progress, it would be shown here

---

### Obtain the receive address

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

In order to show the singleton's pay-to address, run `cic p2_address --prefix txch` (the `--prefix txch` flag is needed because we are running on a testnet).
  
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic p2_address --prefix txch
txch18qj0wwwpfej5ysd8vaaslhr5vrg48qfe6hzqqqmrgc49qxrq7tesdzkvat
```

Note that even though this is the address of the singleton, which has a complex set of rules governing how it may be spent, it can still receive payments, just like coins that use the standard puzzle. We'll send money to it in the next step.

---

### Finance the singleton

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that the singleton has been created and you have its address, you can finance it.
This tutorial committed to funding the singleton with 10 million XCH (your value may be different). Now, we need to send the same amount.

A few notes about the command to finance the singleton:
* Even though you previously specified an amount in _mojos_ when you created the singleton (`-a 10000000000000000000` for this tutorial), you now need to specify the same amount in _XCH_ (`-a 10000000` for this tutorial)
* The `-t` flag needs to specify the `p2_address` you calculated in the last step
* You can optionally add a transaction fee by using the `-m` flag. The example from this tutorial is running on a custom testnet, so the network is not congested and no fee is needed. However, testnet10 is frequently being dusted, so you should add a fee on that network to ensure your transaction is processed quickly. For this tutorial, we'll add a fee of 100 million mojos (`-m 0.00001`), even though it is not needed on this network
* If your fee is greater than your singleton's value (as it might be if you're running on testnet10), you'll need to add the `--override` flag. For demonstration purposes, we'll use it here, even though it is not needed in this case

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia wallet send -a 10000000 -m 0.00001 -t txch18qj0wwwpfej5ysd8vaaslhr5vrg48qfe6hzqqqmrgc49qxrq7tesdzkvat --override
Wallet keys:
1)   502984008
2) * 2447771420 (Synced)
Choose a wallet key [1-2] ('q' to quit, or Enter to use 2447771420):
Submitting transaction...
Transaction submitted to nodes: [{'peer_id': 'f40100b8b46550eb75b79edab4de38611eb543ac8975e262c2d2bf1e1c594312', 'inclusion_status': 'SUCCESS', 'error_msg': None}]
Run 'chia wallet get_transaction -f 2447771420 -tx 0xa10b2efa9c522d2b84ef56245965589fa9bed364fb261bc71f9c6073577b919e' to get status
```

You should see a `'inclusion_status': 'SUCCESS'` in the output.

To get the status of the transaction, run the command indicated at the end out the output. It will take a minute or two to make it onto the blockchain. the output of this command should show `Status: Confirmed`

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia wallet get_transaction -f 2447771420 -tx 0xa10b2efa9c522d2b84ef56245965589fa9bed364fb261bc71f9c6073577b919e
Transaction a10b2efa9c522d2b84ef56245965589fa9bed364fb261bc71f9c6073577b919e
Status: Confirmed
Amount sent: 10000000 TXCH
To address: txch18qj0wwwpfej5ysd8vaaslhr5vrg48qfe6hzqqqmrgc49qxrq7tesdzkvat
Created at: 2022-05-25 12:37:26
```

---

### Verify the singleton's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

Even though the amount available to be withdrawn will increase on chain, it won't increase locally until a new `sync` is performed. This is by design -- it avoids surprises.

Also note that `sync --show` will both sync the singleton locally, as well as show its status.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653454264 (05/25/2022, 12:51:04)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 0
  - amount available: -9956840000000000000
  - amount to claim: 10000000000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
```

`sync --show` does not also show the config details, so you'll have to run `cic show -c` to get them:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -c

Current time: 1653454593 (05/25/2022, 12:56:33)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 0
  - amount available: -9953550000000000000
  - amount to claim: 10000000000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:

Config:
 - started: 05/25/2022, 11:39:08
 - initial amount: 10000000000000000000
 - mojos available per second: 10000000000000
 - current root: f71aa173dc57c4a1e77d5386d5c6b9ece1df82b95139af3c26d123fa4d662103
 - withdrawal timelock: 600 seconds
 - payment clawback period: 1200 seconds
 - rekey cancellation period: 600 seconds
```

The `amount to claim` should now match the `initial amount`.

Note that the `amount available` is still negative. 
This is because the mojos that were used to fund the singleton are still sitting in `amount to claim`. 
Those mojos still need to be absorbed into the singleton, which we'll do in the next step. 
Until this absorption has been accomplished, any attempts to rekey or perform a lock level increase will result in an `ASSERT_SECONDS_ABSOLUTE_FAILED` error.

The singleton is now set up. Observers can verify that no payments or rekeys are currently being performed.

### Create another wallet

You are recommended to create another wallet in order to receive payments from the prefarm. This is done using the same command demonstrated previously in the tutorial:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia keys generate
Generating private key
Added private key with public key fingerprint 2798912978
```

Remember to keep track of this wallet's fingerprint.

As with your other wallet, you should save a copy of the seed phrase for later recovery, as well as its first wallet address to receive payments:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia keys show --show-mnemonic-seed
Showing all public and private keys
...
First wallet address: txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q
...
```

**You are now ready to begin running tests on the singleton.**

---

## Run the custody tests

IPS has created 27 basic test cases for the custody tool.

---

### Test 1 - absorb 1 [todo]
**Title: absorb with no spend**

**Expected result: pass**

---

### Test 2 - absorb 2 [todo]
**Title: Test spend from initial absorb with no xch absorbed yet**

**Expected result: pass**

---

### Test 3 - absorb 3
**Title: Test spend w/ absorb, mixed fund sources**

**Expected result: pass**

:::info
Even though this is one of the first tests, it's actually a bit complex to get set up. You should probably run a few other tests, such as Test 4 or Test 13, to familiarize yourself with the tool before attempting this one.
:::

This test is meant to verify that unabsorbed funds can be spent, along with absorbed funds. You can view these amounts by running `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d

Current time: 1653542249 (05/26/2022, 13:17:29)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 923008000000000000
  - amount to claim: 1000000000000
```

In this example, `amount available` (absorbed funds) is quite large, when compared with `amount to claim` (unabsorbed funds). It's better for the `amount to claim` to be much larger. Recall that `amount available` is increasing by 1 trillion mojos per second for this setup. If you simply added the two numbers shown above and tried to spend the sum, it would only take 1 second for `amount available` to contain that amount anyway. So you can't be sure that the funds being sent are actually coming out of `amount to claim` and are not being absorbed after the money has been sent from `amount available`.

The solution here is to make sure `amount to claim` is significantly larger than `amount available`. The easiest way to set this up is to run [test 13](#test-13---clawback-pass-1) first, with a couple small changes:
1. You should wait for a large amount of funds to become available to be spent. Your singleton should have been running for more than `-wt` seconds + 3600 seconds before attempting it, just to be sure.
2. When you're setting up the withdrawal that you will claw back, make the amount the same as `amount available`. That way you'll claw back a large amount of funds and they'll end up in `amount to claim`.

For this example, here is the singleton's status after running Test 13:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653542753 (05/26/2022, 13:25:53)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9076991000000000000
  - amount available: 5041000000000000
  - amount to claim: 923008000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
```

`amount to claim` is now much larger than `amount available`, so if we withdraw slightly more than `amount to claim`, we can be assured that the funds were actually withdrawn. At this point, we can run a payment similar to Test 4. See that test if you need more details.

#### Initiate a payment
The amount to send is `amount available` + `amount to claim`.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 928049000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5504761145355459203101849175525178992114275889428608138903750229195479515472352142731147726846137574720084663254150407383545227467581229275680744293633423051513301470845273483841710677064539360762720416951547595287640293179726174412248146944
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5449490749007992075521705202886797019062860237437475114504363188924668624607628767020064819097176640639285371584857495958507832770363075136474685715731568570830102812695875426178229751450621842482886354802756212582199880369674657266576668672
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5504761145355459203101849175525178992114275889428608138903750229195479515472352142731147726846137574720084663254150407383545227467581229275680744293633423051513301470845273483841710677064539360762720416951547595287640293179726174412248146944 > .\initial_absorb_1.sig
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5449490749007992075521705202886797019062860237437475114504363188924668624607628767020064819097176640639285371584857495958507832770363075136474685715731568570830102812695875426178229751450621842482886354802756212582199880369674657266576668672 > .\initial_absorb_2.sig
```

#### Merge the payment

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\initial_absorb.unsigned .\initial_absorb_1.sig .\initial_absorb_2.sig > initial_absorb.signed
```

#### Push the transaction to the network

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\initial_absorb.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the payment's status
Here is the status after waiting for the timelock to expire:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653546197 (05/26/2022, 14:23:17)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9071950000000000000
  - amount available: 34440000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
- PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 928049000000000000 (Ready)
  REKEYS:
```

#### Create a signed spend bundle for the completion

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic complete -f complete.signed
Which actions would you like to complete?:

1) PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 928049000000000000
(Enter index of action to complete): 1
Successfully wrote spend to complete.signed
```

#### Push the completion to the blockchain

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\complete.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the completion's status

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653546404 (05/26/2022, 14:26:44)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9071950000000000000
  - amount available: 36510000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
  REKEYS:
```

#### View the recipient wallet

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia wallet show
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
Wallet height: 15547
Sync status: Synced
Balances, fingerprint: 2798912978

Chia Wallet:
   -Total Balance:         928050.0 txch (928050000000000000 mojo)
   -Pending Total Balance: 928050.0 txch (928050000000000000 mojo)
   -Spendable:             928050.0 txch (928050000000000000 mojo)
   -Type:                  STANDARD_WALLET
   -Wallet ID:             1
```

The amount transferred was `928 049` txch. This is significantly greater than the `amount available` at the beginning of the test of `5041` txch. This proves that the unabsorbed and absorbed funds were spent together.

---

### Test 4 - payment pass
**Title: Test basic spend**

**Expected result: pass**

This test will run through the complete sequence of withdrawing money from the singleton.

Keep in mind, the maximum number of mojos able to be withdrawn is shown as `amount available:`, retrieved from the `cic show -c` command. This amount supersedes all other rules for the singleton.

#### Initiate a payment

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

This command generates an unsigned spend bundle which requires specific keys. 
Eventually it will print a QR code, which signers can then scan to obtain their own copy of the spend bundle, 
which they will take to the HSM for signing.

At some point in the future, this step will also assign human readable metadata so that people can know what they're signing before they enter the vault.

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle.
For this example, we'll use the following arguments:

* `-f` : The name of the file in which to save the unsigned spend bundle
* `--pks`: The public keys that will be used to sign the withdrawal. Exactly `m` keys must be included. The only keys allowed to sign are those that were originally used in the `derive_root` command
* `-a`: The number of mojos to withdraw
* `-t`: The recipient address (where to send the money to)
* `-ap`: Absorb all available payments (could add to transaction costs if more than one payment exists)
* `-at`: The minimum coin size to absorb, in mojos (ignore anything smaller than this). 
The default value for this setting is 1 trillion mojos (1 XCH). The prefarm could get dusted, so this command will be helpful as it will ensure that those transactions are ignored.
However, while testing, the desired amount to withdraw is often smaller than 1 trillion mojos, so the default will actually cause the intended withdrawal to fail. If you want to absorb all coins, no matter how small, then set the flag to `0`

Additionally, the following flag will not be modified from its default value here, but it could be useful to change in many contexts:
* `-mc`: Maximum extra cost while absorbing, taken as an estimated percentage. 
If someone sends a bunch of payments and you don't want to absorb them all in one transaction, 
then you'll only pay this much extra in transaction fees. Default is `50` (50%)

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

In this example, the command set up the spend bundle to require keys `1` and `2` to sign. The spend bundle was saved to a file called `initial_absorb.unsigned` in the local directory.

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

Note that the vault can show pubkeys, so you can double-check the keys to sign to make sure they match.

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1` and `2`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\2.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5449140665451649053284096202714691505589365577374007143978191719238477924138728005883662232162434514948867447203715240045617130770165403282022693823446338843409368762077191699285534081208295847253913527216165034379061118404584995264580179968
```

Key 2 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5562136083440889220476123194007748028772506745252267969407877369301599663724642762991158586783630420132355189610554901640702053357066938534730160961964059161490467349960384927960219180153132581064764843327788505287843726328006843878321499136
```

This command spits out a signature encoded in base-10. On Linux it will also show a QR code (the QR display doesn't work on Windows).

Now you can put the signatures into files. Do this by echoing the output of the previous commands and redirecting them with the `>` character:

Key 1:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5449140665451649053284096202714691505589365577374007143978191719238477924138728005883662232162434514948867447203715240045617130770165403282022693823446338843409368762077191699285534081208295847253913527216165034379061118404584995264580179968 > .\initial_absorb_1.sig
```

Key 2:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5562136083440889220476123194007748028772506745252267969407877369301599663724642762991158586783630420132355189610554901640702053357066938534730160961964059161490467349960384927960219180153132581064764843327788505287843726328006843878321499136 > .\initial_absorb_2.sig
```

#### Merge the payment

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

This command will create the signed spend bundle, given the unsigned spend bundle and the individual signature(s).

Note that an arbitrary number of signatures can be passed into this command. We'll use two signatures for this example.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\initial_absorb.unsigned .\initial_absorb_1.sig .\initial_absorb_2.sig > initial_absorb.signed
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

The output of this command is the signed spend bundle, which we've redirected into a text file. This file should be taken out of the HSM to be pushed to the blockchain.

#### Push the transaction to the network

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

A few things to note:
* Even though this command will withdraw from the _singleton_, it still needs a local wallet if you want to add a fee to the spend bundle. If you are using a custom testnet, you won't have any TXCH (other than the prefarm), unless you farm a block or receive some from the IPS infrastructure that is farming. This is OK for most tests because fees aren't required on the custom testnet
* The key to be used in this command is a local key, and _not_ a signer's key from the singleton
* The fee will be added when the `push_tx` command is run; it's not build into the spend bundle

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\initial_absorb.signed
Wallet keys:
1)   502984008
2)   2798912978
3) * 2447771420 (Synced)
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2447771420): 2
{'status': 'SUCCESS', 'success': True}
```

The withdrawal has now been added to the blockchain. However, the money has not yet reached its final destination.
Instead, it will now sit in a "drop coin" (escrow) and cannot be withdrawn for at least (`-pc`) seconds, which is build into the singleton and cannot be changed.
For this example, we used 1200 seconds for this value. The prefarm will set this value to 90 days.

#### View the payment's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

This will show the new status now that the spend bundle has been pushed successfully:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653463866 (05/25/2022, 15:31:06)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999999000000000000
  - amount available: 139179000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
- PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000 (Ready at: 05/25/2022, 15:50:03)
  REKEYS:
  ```

The `amount available` is now a positive number, and it's increasing with each second.

As the output of this command shows, there is a new payment outstanding (`PAYMENT to xch...`). A few things to note:
* For this example, we explicitly specified a `txch` address as the recipient. However, the `xch` address is actually correct -- the tool is simply assuming that the recipient's puzzle hash must correspond to an `xch` address. If you check the puzzle hashes that correspond to both the address you specified previously and the address you see here, you'll see that they are the same.
* If (`-pc`) seconds have not elapsed since the drop coin's creation, the output will display `(Ready at: <mm/dd/yyyy hh:mm:ss>)`
* If (`-pc`) seconds have elapsed, then the output will say `(Ready)`

In either case, claw backs are allowed until the payment is completed.
(Even if the withdrawal is in "Ready" state, it can still be clawed back. However, because _anyone_ can
complete the withdrawal, claw backs should no longer be assumed to be available once they reach the "Ready" state.)

Note that even when the state is "Ready", the next transaction block will still need to be created before the withdrawal is _actually_ ready.

Transaction blocks happen every 52 seconds on average.

#### Create a signed spend bundle for the completion

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

:::info
The `cic complete` command is valid for both payments and rekeys.

Completion of both payments and rekeys require the same steps. 
:::

**Anyone** can run the `cic complete` command. The only argument necessary is the file in which to dump the completion.

First, let's attempt the completion before the drop coin's timelock has expired (this should not work):

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic complete -f complete.signed
Which actions would you like to complete?:

-) PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000
No actions can be completed at this time.
```

Next, after the time lock has expired, run the same command. You do have to enter the correct payment number. It should be `1` (the only option). There is no default, so pressing `enter` will cause an exception.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic complete -f complete.signed
Which actions would you like to complete?:

1) PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000
(Enter index of action to complete): 1
Successfully wrote spend to complete.signed
```

#### Push the completion to the blockchain

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that you have a signed spend bundle, you can actually push it to the blockchain. Just like before, it is possible to add a fee (from a regular wallet) by using the `-m` flag. However, as this example uses a custom testnet, it won't add a fee.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\complete.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the completion's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

After waiting for the next transaction block, the singleton's status should show there are no longer any pending payments or rekeys.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653465662 (05/25/2022, 16:01:02)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999999000000000000
  - amount available: 157139000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
  REKEYS:
```

#### View the recipient wallet

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

Finally, you can run `chia wallet show` with the wallet that received the payment. The amount you requested to be withdrawn should now be in that wallet:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> chia wallet show
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
Wallet height: 11244
Sync status: Synced
Balances, fingerprint: 2798912978

Chia Wallet:
   -Total Balance:         1.0 txch (1000000000000 mojo)
   -Pending Total Balance: 1.0 txch (1000000000000 mojo)
   -Spendable:             1.0 txch (1000000000000 mojo)
   -Type:                  STANDARD_WALLET
   -Wallet ID:             1

Connections:
Type      IP                                     Ports       NodeID      Last Connect      MiB Up|Dwn
FULL_NODE 127.0.0.1                              58445/58445 f40100b8... May 25 16:03:03      0.0|0.0
                                                 -Height: No Info    -Hash: No Info    -Trusted: True
```

In this case, the wallet has 1.0 txch, which is the correct amount.

---

### Test 5 - sign fail 1
**Title: payment: Test with only 1 key specified in 2 of 3 scheme**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass). We'll attempt to initiate a payment with only 1 signature, which should not be allowed.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll intentionally specify only 1 key for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

If you have a QR scanner and are running on Linux, then run the following command, which will display a QR code and wait for you to scan it. **This should fail upon scanning the QR code.**
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponent. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once.

**This command is expected to fail:**

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "C:\Users\User\prefarm_test\internal-custody\venv\Scripts\hsms.exe\__main__.py", line 7, in <module>
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\cmds\hsms.py", line 188, in main
    return hsms(args, parser)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\cmds\hsms.py", line 134, in hsms
    signature_info = sign(unsigned_spend, wallet)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\process\sign.py", line 46, in sign
    more_sigs = sign_for_coin_spend(
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\process\sign.py", line 60, in sign_for_coin_spend
    conditions = conditions_for_coin_spend(coin_spend)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\process\sign.py", line 27, in conditions_for_coin_spend
    CONDITIONS_FOR_COIN_SPEND[coin_spend] = coin_spend.puzzle_reveal.run(
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\streamables\program.py", line 92, in run
    return self.run_with_cost(args, max_cost, strict)[1]
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\hsms\streamables\program.py", line 82, in run_with_cost
    cost, r = run_program(
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\clvm\run_program.py", line 182, in run_program
    cost += f(op_stack, value_stack)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\clvm\run_program.py", line 172, in apply_op
    additional_cost, r = operator_lookup(op, operand_list)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\clvm\operators.py", line 195, in __call__
    return f(arguments)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\clvm\core_ops.py", line 49, in op_raise
    raise EvalError("clvm raise", args)
clvm.EvalError.EvalError: clvm raise
```

If you receive a similar error, then this test passes.

---

### Test 6 - sign fail 2
**Title: Test spend with 1 of 2 signatures**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass). We'll attempt to initiate a payment with 2 signatures, which is expected. But then we'll create a spend bundle with only 1 signature, which is not allowed.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll specify 2 keys for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

**For this part of the test, we'll only collect 1 signature.**

If you have a QR scanner and are running on Linux, then run the following command, which will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponent. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5501541541517338495578471622851116085699274300198783202930807340881517107611904112441943325692516383430726033394972658869357352329472741563894336793609004192249016283573773582621707773417747879985238658502642315785200478072414353521426063360
```

This command spits out a signature encoded in base-10. On Linux it will also show a QR code (the QR display doesn't work on Windows).

Now you can put the signature into a file:

Key 1:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5501541541517338495578471622851116085699274300198783202930807340881517107611904112441943325692516383430726033394972658869357352329472741563894336793609004192249016283573773582621707773417747879985238658502642315785200478072414353521426063360 > .\initial_absorb_1.sig
```

#### Merge the payment

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

This command will create a signed spend bundle with only 1 signature. Two signatures are required, but the test will not fail until we try to push the spend bundle to the blockchain.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\initial_absorb.unsigned .\initial_absorb_1.sig > initial_absorb.signed
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

#### Push the transaction to the network

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now we'll attempt to push the invalid spend bundle to the blockchain. **This step should fail.**

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\initial_absorb.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "C:\Users\User\prefarm_test\internal-custody\venv\Scripts\cic.exe\__main__.py", line 7, in <module>
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1938, in main
    cli()  # pylint: disable=no-value-for-parameter
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 829, in __call__
    return self.main(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 782, in main
    rv = self.invoke(ctx)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1259, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1066, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 610, in invoke
    return callback(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 900, in push_cmd
    asyncio.get_event_loop().run_until_complete(do_command())
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\base_events.py", line 642, in run_until_complete
    return future.result()
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 891, in do_command
    result = await node_client.push_tx(SpendBundle.aggregate(spends))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\chia\rpc\full_node_rpc_client.py", line 204, in push_tx
    return await self.fetch("push_tx", {"spend_bundle": spend_bundle.to_json_dict()})
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\chia\rpc\rpc_client.py", line 49, in fetch
    raise ValueError(res_json)
ValueError: {'error': 'Failed to include transaction 6b6af057c79186156612b6f51fb47f24441ff59669442ded66a636e890d880fa, error BAD_AGGREGATE_SIGNATURE', 'success': False}
```

If you receive a similar error **BAD_AGGREGATE_SIGNATURE**, then this test passes.

---

### Test 7 - sign fail 3
**Title: Test spends with correct # of sigs, but incorrect combinations: 2 valid signers, but not the signers listed when creating the spendbundle**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass). We'll initiate a payment with 1.pk and 2.pk, which is valid. Then we'll sign a spend bundle with 1.pk and 3.pk. Even though 3.pk is valid with this configuration, pushing this spend bundle to the blockchain should fail because we didn't use 1.pk and 2.pk in the spend bundle.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll specify 2 keys for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

**In this step, we'll sign with 1.se and 3.se, which is not allowed.**

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1` and `3`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\3.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5501541541517338495578471622851116085699274300198783202930807340881517107611904112441943325692516383430726033394972658869357352329472741563894336793609004192249016283573773582621707773417747879985238658502642315785200478072414353521426063360
```

Key 3 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\3.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

When attempting to gather a signature for 3.se, there was no output. This is because 3.se was not part of the unsigned spend bundle. There is no signature to collect, so the rest of this test will look just like [Test 6](#test-6---sign-fail-2). From here you can follow that test and push the invalid spend bundle to the blockchain, resulting in a BAD_AGGREGATE_SIGNATURE. At that point, this test will have passed.

---

### Test 8 - sign fail 4
**Title: Test spends with correct # of sigs, but incorrect combinations: 1 valid signer not listed in spendbundle, 1 completely random signer**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass).

First we'll create a new key called 1_random.se.

Next we'll initiate a payment with 1.pk and 2.pk, which is valid. Then we'll sign a spend bundle 3.pk and 1_random.pk. Even though 3.pk is valid with this configuration, pushing this spend bundle to the blockchain should fail because we didn't use 1.pk and 2.pk in the spend bundle. On top of that, 1_random.pk is not even a valid key for this configuration.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Create a random key

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmgen > 1_random.se
```

Next, use the `hsmpk` command to derive a public key from the secret exponent:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmpk $(cat .\1_random.se) > 1_random.pk
```

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll specify 2 keys for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

**In this step, we'll sign with 3.se and 1_random.se, which is not allowed.**

If you have a QR scanner and are running on Linux, then run the following commands (for keys `3` and `1_random`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\3.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1_random.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 3 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\3.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

Key 1_random sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1_random.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

When attempting to gather a signature both of these keys, there was no output. This is because 3.se was not part of the unsigned spend bundle, and 1_random was not even valid in the configuration. There are no signatures to collect, so the rest of this test will look just like [Test 6](#test-6---sign-fail-2). From here you can follow that test and push the invalid spend bundle to the blockchain, resulting in a BAD_AGGREGATE_SIGNATURE. At that point, this test will have passed.

---

### Test 9 - sign fail 5
**Title: Test spends with correct # of sigs, but incorrect combinations: 1 valid signer, one random signer**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass).

You'll need a key called 1_random.se, which was created in [Test 8](#test-8---sign-fail-4).

We'll initiate a payment with 1.pk and 2.pk, which is valid. Then we'll sign a spend bundle 1.pk and 1_random.pk. 1_random.pk is not a valid key for this configuration, so pushing this spend bundle to the blockchain should fail. 

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll specify 2 keys for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

**In this step, we'll sign with 1.se and 1_random.se, which is not allowed.**

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1` and `1_random`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1_random.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5501541541517338495578471622851116085699274300198783202930807340881517107611904112441943325692516383430726033394972658869357352329472741563894336793609004192249016283573773582621707773417747879985238658502642315785200478072414353521426063360
```

Key 1_random sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1_random.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

When attempting to gather a signature for 1_random, there was no output. This is because 1_random was not valid in the configuration. There is no signature to collect, so the rest of this test will look just like [Test 6](#test-6---sign-fail-2). From here you can follow that test and push the invalid spend bundle to the blockchain, resulting in a BAD_AGGREGATE_SIGNATURE. At that point, this test will have passed.

---

### Test 10 - sign fail 6
**Title: Test spends with correct # of sigs, but incorrect combinations: 2 random signers**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass).

You'll need a key called 1_random.se, which was created in [Test 8](#test-8---sign-fail-4).
We'll also create another key called called 2_random.se.

We'll initiate a payment with 1.pk and 2.pk, which is valid. Then we'll sign a spend bundle 1_random.se and 2_random.se. Neither of these keys is valid for this configuration, so pushing this spend bundle to the blockchain should fail. 

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Create a random key

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmgen > 2_random.se
```

Next, use the `hsmpk` command to derive a public key from the secret exponent:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmpk $(cat .\2_random.se) > 2_random.pk
```

#### Initiate a payment

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle. We'll specify 2 keys for signing:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to initial_absorb.unsigned
```

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

**In this step, we'll sign with 1_random.se and 2_random.se, which is not allowed.**

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1_random` and `2_random`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1_random.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\2_random.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1_random sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1_random.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

Key 2_random sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\2_random.se
waiting for qrint-encoded signing requests
>
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

Neither of these signing attempts yielded any output. This is because 1_random and 2_random were not valid in the configuration. There is no signature to collect, so the rest of this test will look just like [Test 6](#test-6---sign-fail-2). From here you can follow that test and push the invalid spend bundle to the blockchain, resulting in a BAD_AGGREGATE_SIGNATURE. At that point, this test will have passed.

---

### Test 11 - spend bundle fail 1
**Title: Test generating spendbundles with random pub keys: 1 random, 1 correct pubkey**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass).

You'll need a key called 1_random.se, which was created in [Test 8](#test-8---sign-fail-4).

We'll attempt to initiate a payment with 1.pk and 1_random.pk, 1.pk is part of the configuration, but 1_random.pk is not. This should cause an immediate failure.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

Run the `cic payment` command with 1 invalid key. **This command is expected to fail.**

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1.pk,1_random.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "C:\Users\User\prefarm_test\internal-custody\venv\Scripts\cic.exe\__main__.py", line 7, in <module>
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1938, in main
    cli()  # pylint: disable=no-value-for-parameter
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 829, in __call__
    return self.main(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 782, in main
    rv = self.invoke(ctx)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1259, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1066, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 610, in invoke
    return callback(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1046, in payments_cmd
    asyncio.get_event_loop().run_until_complete(do_command())
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\base_events.py", line 642, in run_until_complete
    return future.result()
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1005, in do_command
    singleton_bundle, data_to_sign = get_withdrawal_spend_info(
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\drivers\prefarm.py", line 154, in get_withdrawal_spend_info
    filter_proof, leaf_proof = (list(proof.items())[0][1] for proof in derivation.get_proofs_of_inclusion(agg_pk))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\drivers\puzzle_root_construction.py", line 58, in get_proofs_of_inclusion
    raise ValueError("Could not find a puzzle matching the specified pubkey")
ValueError: Could not find a puzzle matching the specified pubkey
```

If you received a similar error, then this test passes.

---

### Test 12 - spend bundle fail 2
**Title: Test generating spendbundles with random pub keys: 2 random pubkeys**

**Expected result: fail**

For this test, we'll use the same configuration that was used for [Test 4](#test-4---payment-pass).

You'll need a key called 1_random.se, which was created in [Test 8](#test-8---sign-fail-4).
You'll also need a key called 2_random.se, which was created in [Test 10](#test-10---sign-fail-6).

We'll attempt to initiate a payment with 1_random.pk and 2_random.pk. Neither of these keys are part of the configuration. This should cause an immediate failure.

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2 and the max lock level (`n`) is 3. The pubkeys match 1.pk, 2.pk, and 3.pk.
This is what we want.

#### Initiate a payment

Run the `cic payment` command with 2 invalid keys. **This command is expected to fail.**

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f initial_absorb.unsigned -pks "1_random.pk,2_random.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Traceback (most recent call last):
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\runpy.py", line 87, in _run_code
    exec(code, run_globals)
  File "C:\Users\User\prefarm_test\internal-custody\venv\Scripts\cic.exe\__main__.py", line 7, in <module>
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1938, in main
    cli()  # pylint: disable=no-value-for-parameter
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 829, in __call__
    return self.main(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 782, in main
    rv = self.invoke(ctx)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1259, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 1066, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\click\core.py", line 610, in invoke
    return callback(*args, **kwargs)
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1046, in payments_cmd
    asyncio.get_event_loop().run_until_complete(do_command())
  File "C:\Users\User\AppData\Local\Programs\Python\Python39\lib\asyncio\base_events.py", line 642, in run_until_complete
    return future.result()
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\cli\main.py", line 1005, in do_command
    singleton_bundle, data_to_sign = get_withdrawal_spend_info(
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\drivers\prefarm.py", line 154, in get_withdrawal_spend_info
    filter_proof, leaf_proof = (list(proof.items())[0][1] for proof in derivation.get_proofs_of_inclusion(agg_pk))
  File "C:\Users\User\prefarm_test\internal-custody\venv\lib\site-packages\cic\drivers\puzzle_root_construction.py", line 58, in get_proofs_of_inclusion
    raise ValueError("Could not find a puzzle matching the specified pubkey")
ValueError: Could not find a puzzle matching the specified pubkey
```

If you received a similar error, then this test passes.

---

### Test 13 - clawback pass 1
**Title: clawback (payment): before clawback expires**

**Expected result: pass**

This test will set up a payment and claw it back.

Keep in mind, the maximum number of mojos able to be withdrawn is shown as `amount available:`, retrieved from the `cic show -c` command. This amount supersedes all other rules for the singleton.

#### Initiate a payment

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

This command generates an unsigned spend bundle which requires specific keys. 
Eventually it will print a QR code, which signers can then scan to obtain their own copy of the spend bundle, 
which they will take to the HSM for signing.

At some point in the future, this step will also assign human readable metadata so that people can know what they're signing before they enter the vault.

To begin the payment process, use the `cic payment` command to generate an unsigned spend bundle.
For this example, we'll use the following arguments:

* `-f` : The name of the file in which to save the unsigned spend bundle
* `--pks`: The public keys that will be used to sign the withdrawal. Exactly `m` keys must be included. The only keys allowed to sign are those that were originally used in the `derive_root` command
* `-a`: The number of mojos to withdraw
* `-t`: The recipient address (where to send the money to)
* `-ap`: Absorb all available payments (could add to transaction costs if more than one payment exists)
* `-at`: The minimum coin size to absorb, in mojos (ignore anything smaller than this). 
The default value for this setting is 1 trillion mojos (1 XCH). The prefarm could get dusted, so this command will be helpful as it will ensure that those transactions are ignored.
However, while testing, the desired amount to withdraw is often smaller than 1 trillion mojos, so the default will actually cause the intended withdrawal to fail. If you want to absorb all coins, no matter how small, then set the flag to `0`

Additionally, the following flag will not be modified from its default value here, but it could be useful to change in many contexts:
* `-mc`: Maximum extra cost while absorbing, taken as an estimated percentage. 
If someone sends a bunch of payments and you don't want to absorb them all in one transaction, 
then you'll only pay this much extra in transaction fees. Default is `50` (50%)

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic payment -f clawback_test.unsigned -pks "1.pk,2.pk" -a 1000000000000 -t txch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs8k2u2q -ap -at 0
Successfully wrote spend to clawback_test.unsigned
```

In this example, the command set up the spend bundle to require keys `1` and `2` to sign. The spend bundle was saved to a file called `clawback_test.unsigned` in the local directory.

#### Sign the payment

* These commands will **not** modify the blockchain
* These commands should be run from **inside** the vault

Note that the vault can show pubkeys, so you can double-check the keys to sign to make sure they match.

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1` and `2`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\2.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\clawback_test.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5472127595259769624700272313291141996052950924857113076610741554495992119011254960749667050480669480305548405876470602767481810282080179981661010737772387725421731729293622731280244523247244271582141624131940606770107363924272162087952400384
```

Key 2 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\clawback_test.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5444445217649174440214246152919408353372706707176144269560546771583582721098966498090776688613846319205565483834891832664136315894504133724968122369642627817370341121459531985264754446159866249757141932375685695182533245475382348602919235584
```

This command spits out a signature encoded in base-10. On Linux it will also show a QR code (the QR display doesn't work on Windows).

Now you can put the signatures into files. Do this by echoing the output of the previous commands and redirecting them with the `>` character:

Key 1:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5472127595259769624700272313291141996052950924857113076610741554495992119011254960749667050480669480305548405876470602767481810282080179981661010737772387725421731729293622731280244523247244271582141624131940606770107363924272162087952400384 > clawback_test_1.sig
```

Key 2:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5444445217649174440214246152919408353372706707176144269560546771583582721098966498090776688613846319205565483834891832664136315894504133724968122369642627817370341121459531985264754446159866249757141932375685695182533245475382348602919235584 > clawback_test_2.sig
```

#### Merge the payment

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

This command will create the signed spend bundle, given the unsigned spend bundle and the individual signature(s).

Note that an arbitrary number of signatures can be passed into this command. We'll use two signatures for this example.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\clawback_test.unsigned .\clawback_test_1.sig .\clawback_test_2.sig > .\clawback_test.signed
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

The output of this command is the signed spend bundle, which we've redirected into a text file. This file should be taken out of the HSM to be pushed to the blockchain.

#### Push the transaction to the network

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

A few things to note:
* Even though this command will withdraw from the _singleton_, it still needs a local wallet if you want to add a fee to the spend bundle. If you are using a custom testnet, you won't have any TXCH (other than the prefarm), unless you farm a block or receive some from the IPS infrastructure that is farming. This is OK for most tests because fees aren't required on the custom testnet
* The key to be used in this command is a local key, and _not_ a signer's key from the singleton
* The fee will be added when the `push_tx` command is run; it's not build into the spend bundle

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\clawback_test.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

The withdrawal has now been added to the blockchain. However, the money has not yet reached its final destination.
Instead, it will now sit in a "drop coin" (escrow) and cannot be withdrawn for at least (`-pc`) seconds, which is build into the singleton and cannot be changed.
For this example, we used 1200 seconds for this value. The prefarm will set this value to 90 days.

#### View the payment's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

This will show the new status now that the spend bundle has been pushed successfully:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653478682 (05/25/2022, 19:38:02)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 287338000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
- PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000 (Ready at: 05/25/2022, 19:56:52)
  REKEYS:
  ```

The `amount available` is now a positive number, and it's increasing with each second.

As the output of this command shows, there is a new payment outstanding (`PAYMENT to xch...`).

After the timestamp shown by `(Ready at: <mm/dd/yyyy hh:mm:ss>)`, the payment will be ready for completion. **For this test, you need to claw back the payment before this time.**

#### Create an unsigned spend bundle

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

For this test, the claw back will make a payment (p2_singleton) back to the original singleton. The payment must later be absorbed.

Claw back requires the same number of keys that originally signed the payment or rekey. For this test it's OK to use the same keys (1.pk and 2.pk).

You need to respond with the index number of the payment to claw back, which should be `1`.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic clawback -f clawback.unsigned -pks "1.pk,2.pk"
Which actions would you like to cancel?:

1) PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000
(Enter index of action to cancel): 1
Successfully wrote spend to clawback.unsigned
```

The output of this command will be a new unsigned spend bundle called `clawback.unsigned` in the current directory.

#### Sign the claw back spend bundle

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

First, obtain a base-64 signature for each secret exponent (it might instead be in base-10):

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\clawback.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5452288223536177585645077673145525300036501980511145254073503422535764112057333911271204274097872247045160832790029532455857764558235854188835670998643202123302975844048112116854539244523201007860281417801632194813622278850102057600033554432
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\clawback.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5610038955636809163462926683606146326062159892638414582047148228930999956391284285833507059367616481570350590412769330547119147411147944313274258244439839038729813133835994167893237199174883125089758553763754514470482682280102132661023410176
```

Next, put each signature into a text file:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5452288223536177585645077673145525300036501980511145254073503422535764112057333911271204274097872247045160832790029532455857764558235854188835670998643202123302975844048112116854539244523201007860281417801632194813622278850102057600033554432 > .\clawback_1.sig
```
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5610038955636809163462926683606146326062159892638414582047148228930999956391284285833507059367616481570350590412769330547119147411147944313274258244439839038729813133835994167893237199174883125089758553763754514470482682280102132661023410176 > .\clawback_2.sig
```

Finally, merge the claw back signatures into a signed spend bundle. 
Note that an arbitrary number of signatures can be passed into this command. We'll use two signatures for this example.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\clawback.unsigned .\clawback_1.sig .\clawback_2.sig > clawback.signed
```

#### Push the claw back to the network

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that you have a signed spend bundle, all that remains is pushing it to the blockchain. If you are running on testnet10, you may want to include a fee by using the `-m` flag and selecting a wallet that has sufficient funds to pay the fee.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\clawback.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the claw back's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

If you view the singleton's status right away, you will still see the active PAYMENT. This is because the blockchain has yet to process the clawback:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653479087 (05/25/2022, 19:44:47)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 291388000000000000
  - amount to claim: 0

Outstanding events:
  PAYMENTS:
- PAYMENT to xch1q03d7grhvat0wrv7cxu6kxjksz0n2qng6ruw6src5642kyxyphrs23d2tn of amount 1000000000000 (Ready at: 05/25/2022, 19:56:52)
  REKEYS:
```

Take note of the `Current time:` and `Ready at:` timestamps in the output above. This is good -- the clawback was pushed to the blockchain around 12 minutes before the timelock expired.

Wait a few minutes and run the same command again. You'll see that the clawback is now gone and the funds are now in `amount to claim:`

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653479188 (05/25/2022, 19:46:28)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 292398000000000000
  - amount to claim: 1000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
```

Note that `amount to claim:` still has a positive value. This will automatically be absorbed into the singleton with the next spend.

---

---

### Test 14 - clawback pass 2 [todo]
**Title: clawback (payment): after clawback expires, but before someone completed the payment**

**Expected result: pass**

---

### Test 15 - clawback fail 1 [todo]
**Title: payment: test push tx after clawback completed**

**Expected result: fail**

---

### Test 16 - payment fail [todo]
**Title: payment: Test new payment before previous payment timelock expires**

**Expected result: fail**

---

### Test 17 - clawback pass 3 [todo]
**Title: clawback: Ensure clawback window starts when tx is pushed to chain**

**Expected result: pass**

---

### Test 18  - sign fail 9 [todo]
**Title: rekey: Push with no signatures**

**Expected result: fail**

---

### Test 19 - rekey clawback pass 1 [todo]
**Title: clawback (slow rekey): before clawback expires**

**Expected result: pass**

---

### Test 20 - rekey clawback pass 2 [todo]
**Title: clawback (slow rekey): after clawback expires, before completed**

**Expected result: pass**

---

### Test 21 - rekey clawback fail 1 [todo]
**Title: clawback (slow rekey): complete after clawed back**

**Expected result: fail**

---

### Test 22 - rekey clawback pass 3 [todo]
**Title: clawback (normal rekey): before clawback expires**

**Expected result: pass**

---

### Test 23 - rekey clawback pass 4 [todo]
**Title: clawback (normal rekey): after clawback expires, before completed**

**Expected result: pass**

---

### Test 24 - rekey clawback fail 2 [todo]
**Title: clawback (normal rekey): complete after clawed back**

**Expected result: fail**

---

### Test 25 - rekey pass 1
**Title: rekey: replace 2 of 3 keys with 2 new keys**

**Expected result: pass**

To do a rekey, you need to re-derive the root (singleton).
It's not possible to recreate the singleton because it contains immutable info.

For this test, we'll attempt a normal rekey, which requires `m` keys. 

#### Create new keys

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

In this example, we'll create 2 new keys:

```powershell
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsmgen > 1_new.se
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsmgen > 2_new.se
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsmpk $(cat .\1_new.se) > 1_new.pk
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsmpk $(cat .\2_new.se) > 2_new.pk
```

#### Re-derive the root

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

This command will create a new configuration file. A few things to note:
* `-pks`, `-m` and `-n` all refer to the values that will be applied to the _next_ root (after the rekey)
* `3.pk` was in the previous root as well (we've changed 2 out of the 3 keys)
* `sync (<number>).sqlite` refers to the _current_ databse file
* `Configuration (after rekey).txt` is a new configuration file that will be created as a result of running this command

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic derive_root -db '.\sync (7c75d5).sqlite' -c '.\Configuration (after rekey).txt' -pks "1_new.pk,2_new.pk,3.pk" -m 2 -n 3
Custody rules successfully added to configuration
```

#### Start the rekey

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

Next, create an unsigned spend bundle for the rekey. Note that in this command, 
`-pks` refers to the original keys that must sign to allow the rekey to happen. 
The configuration file from the `-new` flag contains all of the new info that will be used after the rekey has completed.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic start_rekey -f rekey.unsigned -pks "1.pk,2.pk" -new '.\Configuration (after rekey).txt'
Successfully wrote spend to rekey.unsigned
```

The output of this command is the unsigned spend bundle that will be used for the rekey.

---

#### Sign the rekey spend bundle

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

This command will sign the spend bundle. This command must be run for each key with which you previously indicated you would sign:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\rekey.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5616487008962809716216552727987825138051341426054998553730560496068989646005191054591443973472399076014813695995680279925853787058978851575901708893486574715237405564476437845304494529494675267699103951557957690696955485177170013463372220416
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\rekey.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5562174267317429243926851056645562097690232252851104411783069127842442639937086101339489507437882976274982883257157067849153345902077749141922781039415482864525148719637012676931598730111535979999540742741406528284356296809937945875972688896
```

Next, put each signature into a text file:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5616487008962809716216552727987825138051341426054998553730560496068989646005191054591443973472399076014813695995680279925853787058978851575901708893486574715237405564476437845304494529494675267699103951557957690696955485177170013463372220416 > rekey_1.sig
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5562174267317429243926851056645562097690232252851104411783069127842442639937086101339489507437882976274982883257157067849153345902077749141922781039415482864525148719637012676931598730111535979999540742741406528284356296809937945875972688896 > rekey_2.sig
```

Finally, merge the rekey signatures into a signed spend bundle. 
Note that an arbitrary number of signatures can be passed into this command. 
For this example, we need to use the two signatures we just calculated:

```powershell
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsmmerge .\rekey.unsigned .\rekey_1.sig .\rekey_2.sig > rekey.signed
```

As a result of running this command, a signed spend bundle will be created for the rekey.

#### Push the rekey to the network

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that you have a signed spend bundle, all that remains is pushing it to the blockchain. If you are running on testnet10, you may want to add a fee by using the `-m` flag.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\rekey.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the rekey's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

Wait a few minutes for the transaction to be processed, then update the singleton's status to show that the rekey is in progress. This will show the old and new puzzle roots.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653482803 (05/25/2022, 20:46:43)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 328548000000000000
  - amount to claim: 1000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
- REKEY from f71aa173dc57c4a1e77d5386d5c6b9ece1df82b95139af3c26d123fa4d662103 to 389c0dce676ecc9b6041a93b199aa99410b2c10352192f0061597be2448b2a97 (Ready at: 05/25/2022, 20:55:30)
```

As the output of this command shows, there is a new rekey outstanding (`REKEY from...`).
* If (`-rc`) seconds have not elapsed since the drop coin's creation, the output will display `(Ready at: <mm/dd/yyyy hh:mm:ss>)`
* If (`-rc`) seconds have elapsed, then the output will say `(Ready)`

In either case, claw backs are allowed until the rekey is completed.
(Even if the rekey is in "Ready" state, it can still be clawed back. However, because _anyone_ can
complete the rekey, claw backs should no longer be assumed to be available once they reach the "Ready" state.)

Note that even when the state is "Ready", the next transaction block will still need to be created before the rekey is _actually_ ready.
Transaction blocks happen every 52 seconds on average.

#### Create a signed spend bundle for the completion

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

:::info
The `cic complete` command is valid for both payments and rekeys.

Completion of both payments and rekeys require the same steps. 
:::

**Anyone** can run the `cic complete` command. The only argument necessary is the file in which to dump the completion.

First, let's attempt the completion before the rekey's timelock has expired (this should not work):

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic complete -f .\rekey.signed
Which actions would you like to complete?:

-) REKEY from f71aa173dc57c4a1e77d5386d5c6b9ece1df82b95139af3c26d123fa4d662103 to 389c0dce676ecc9b6041a93b199aa99410b2c10352192f0061597be2448b2a97
No actions can be completed at this time.
```

Next, after the time lock has expired, run the same command. You do have to enter the correct rekey number. It should be `1` (the only option). There is no default, so pressing `enter` will cause an exception.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic complete -f .\rekey.signed
Which actions would you like to complete?:

1) REKEY from f71aa173dc57c4a1e77d5386d5c6b9ece1df82b95139af3c26d123fa4d662103 to 389c0dce676ecc9b6041a93b199aa99410b2c10352192f0061597be2448b2a97
(Enter index of action to complete): 1
Successfully wrote spend to .\rekey.signed
```

#### Push the completion to the blockchain

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that you have a signed spend bundle, you can actually push it to the blockchain. Just like before, it is possible to add a fee (from a regular wallet) by using the `-m` flag. However, as this example uses a custom testnet, it won't add a fee.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\rekey.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

#### View the completion's status

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

After waiting for the next transaction block, the singleton's status should show there are no longer any pending payments or rekeys.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show
Configuration is outdated, please update it with command cic update_config

Current time: 1653483623 (05/25/2022, 21:00:23)

Config up to date: False

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 336748000000000000
  - amount to claim: 1000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
```

Note that `amount to claim:` still has a positive value. This will automatically be absorbed into the singleton with the next spend.

#### Update the local configuration

At this point, the rekey has completed, but your local config is outdated. Any attempts at creating payments or rekeys will fail. The node is essentially an observer.

To show this, let's show each of the public keys:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat 1.pk
bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat 2.pk
bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat 3.pk
bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj

(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat 1_new.pk
bls12381k4cxla3l5aumu62smwtne6sv6rcfkt63sl54rf08jayzfw0phazvxnh8asmt9dj66q4mgzr5vr9xs02lmcl
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat 2_new.pk
bls123815nqnsmc0xtj3upl2gl06r8lu8lj45t4d809w4gnc2etg79gpas3aza5c00zl5c7ulwmuqz8u5qecws6mmdq
```

And now let's show the details of the configuration that the custody tool is currently using:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The three pubkeys are from the _old_ configuration. This is fixed with the `update_config` command:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic update_config -c '.\Configuration (after rekey).txt'
Configuration update successful
```

Finally, let's look at the configuration details again:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123815nqnsmc0xtj3upl2gl06r8lu8lj45t4d809w4gnc2etg79gpas3aza5c00zl5c7ulwmuqz8u5qecws6mmdq
    - bls12381k4cxla3l5aumu62smwtne6sv6rcfkt63sl54rf08jayzfw0phazvxnh8asmt9dj66q4mgzr5vr9xs02lmcl
```

The correct keys are now being used.

Note that each of the nodes that are allowed to sign should receive a copy of the new configuration.

---

### Test 26 - rekey pass 2 [todo]
**Title: rekey: add additional keys**

**Expected result: pass**

---

### Test 27 - lock level increase pass
**Title: rekey: increase lock level**

**Expected result: pass**

For this test, we'll start with the same configuration that was used for [Test 4](#test-4---payment-pass).

This test won't go into the details for how to set up the configuration. If you need these details, see [the Derive Root](#derive-puzzles) section.

Just to be sure the configuration is set up correctly beforehand, run `cic show -d`:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic show -d
...
Derivation Info:
 - lock level: 2
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

The lock level (`m`) is 2. This is what we want to start with. **This test will increase `m` to 3.**

A lock level increase is also known as a _security level_ increase.
It will increment `m`, the number of keys required to sign withdrawals and normal rekeys.
`m + 1` keys are required to perform a lock level increase. The change happens instantly; there are no timelocks.

#### Create an unsigned spend bundle

* This command will **not** modify the blockchain
* This command should be run from **outside** the vault

We're increasing the lock level to `3`, so 3 signatures are required.

The following command will create an unsigned spend bundle in the current directory:

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic increase_security_level -db '.\sync (7c75d5).sqlite' -pks "1.pk,2.pk,3.pk" -f lock.unsigned
Successfully wrote spend to lock.unsigned
```

#### Obtain the necessary signatures

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

If you have a QR scanner and are running on Linux, then run the following commands (for keys `1`, `2`, and `3`). They will display a QR code and wait for you to scan it:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\1.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\2.se
waiting for qrint-encoded signing requests
>
```

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsms .\3.se
waiting for qrint-encoded signing requests
>
```

If you don't have a QR scanner or are running on Windows, you can mimic using a scanner by showing the spend bundle and piping the signed secret exponents. The `-y` flag will skip confirmations; the `--nochunks` flag will read the whole spendbundle at once:

Key 1 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\lock.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5543149580043353028764433237761749949004864024864911367928779399935342074364924457382656282424117422204294051824998381684149704755122607611640566142562020887597003449119704065758939440998203777628400000586147747640971539250167608590520093696
```

Key 2 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\lock.unsigned | hsms -y --nochunks .\2.se
waiting for qrint-encoded signing requests
> 5574083793927203425636126739737229001129757036285432055649274256196445331353594885881952242437834861076949422114504117486617723800535341871996084904530288371859129189007726935830522469074466139668070296041101734074358697368406279817113539584
```

Key 3 sign:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\lock.unsigned | hsms -y --nochunks .\3.se
waiting for qrint-encoded signing requests
> 5514838603659553620246870682895692111246568871270265209023086177993777137935990454939626775217031531177051884390958529881442092513875908185163240456088084449881384538037920097861848343853313700812305595289729964684289915848112333175452595200
```

This command spits out a signature encoded in base-10. On Linux it will also show a QR code (the QR display doesn't work on Windows).

Now you can put the signatures into files. Do this by echoing the output of the previous commands and redirecting them with the `>` character:

Key 1:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5543149580043353028764433237761749949004864024864911367928779399935342074364924457382656282424117422204294051824998381684149704755122607611640566142562020887597003449119704065758939440998203777628400000586147747640971539250167608590520093696 > lock_1.sig
```

Key 2:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5574083793927203425636126739737229001129757036285432055649274256196445331353594885881952242437834861076949422114504117486617723800535341871996084904530288371859129189007726935830522469074466139668070296041101734074358697368406279817113539584 > lock_2.sig
```

Key 3:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> echo 5514838603659553620246870682895692111246568871270265209023086177993777137935990454939626775217031531177051884390958529881442092513875908185163240456088084449881384538037920097861848343853313700812305595289729964684289915848112333175452595200 > lock_3.sig
```

#### Merge the payment

* This command will **not** modify the blockchain
* This command should be run from **inside** the vault

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> hsmmerge .\lock.unsigned .\lock_1.sig .\lock_2.sig .\lock_3.sig > lock.signed
(venv) PS C:\Users\User\prefarm_test\keys_and_sb>
```

The output of this command is the signed spend bundle, which we've redirected into a text file. This file should be taken out of the HSM to be pushed to the blockchain.

#### Push the lock level increase to the blockchain

* This command **will** modify the blockchain
* This command should be run from **outside** the vault

Now that we have a signed spend bundle, we can push it to the blockchain. You can add a transaction fee (recommended if you're running on testnet10) by using the `-m` flag.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic push_tx -b .\lock.signed
Wallet keys:
1)   502984008
2) * 2798912978 (Synced)
3)   2447771420
Choose a wallet key [1-3] ('q' to quit, or Enter to use 2798912978):
{'status': 'SUCCESS', 'success': True}
```

The lock level increase will be added to the blockchain with the next transaction block. After waiting a few minutes, run `cic sync --show`, which will update your configuration. You should see `Config up to date: True` in the output.

```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cic sync --show

Current time: 1653538883 (05/26/2022, 12:21:23)

Config up to date: True

Singleton:
  - launcher ID: 7c75d5abb324c7a93186bcb05b2d8da7dccf4ff5072c28581574649dfdeee0c1
  - amount left: 9999998000000000000
  - amount available: 889348000000000000
  - amount to claim: 1000000000000

Outstanding events:
  PAYMENTS:
  REKEYS:
```

Finally, run `cic show -d` to display your derivation info:

```powershell
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> cic show -d
...
Derivation Info:
 - lock level: 3
 - max lock level: 3
 - min keys to rekey: 1
 - standard rekey timelock: 300 seconds
 - slow rekey penalty: 900 seconds
 - pubkeys:
    - bls12381szculp6dpqmmm6q88y7qltlexcn776g8vjhe6ghg5x857z5vl8k9ge35juym3ruv6q6csn98hmcnqn70taj
    - bls123813uyfwgn5qqls28hmtyc2877p99h7gflpz3z4t8nlvfamuzrmfmtn8tnll7snjz8tnrry43gvh0l2j4leuql
    - bls123815p22qpch6d6hcy8sh8c8gn75t0xxjstvp2upkkh5y6mjd40c37ltpx3c4n0nzx3fmqj6ck3sr353ym3m3z2
```

If the lock level has been increased to 3, then the test passes. Note that the keys themselves haven't changed. However, all three will now be required to make any payments.

---

## CIC CLI commands and reference

The commands listed in this section can all be found by running `cic`:

```powershell
(venv) PS C:\Users\User\internal-custody> cic -h
```

### Commands

* [`audit`](#audit)
* [`clawback`](#clawback)
* [`complete`](#complete)
* [`derive_root`](#derive_root)
* [`examine_spend`](#examine_spend)
* [`export_config`](#export_config)
* [`increase_security_level`](#increase_security_level)
* [`init`](#init)
* [`launch_singleton`](#launch_singleton)
* [`p2_address`](#p2_address)
* [`payment`](#payment)
* [`push_tx`](#push_tx)
* [`show`](#show)
* [`start_rekey`](#start_rekey)
* [`sync`](#sync)
* [`update_config`](#update_config)

### Reference

### `audit`

Functionality: Export a history of the singleton to a CSV

Usage: `cic audit [OPTIONS]`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -db           | --db-path    | TEXT | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -f            | --filepath   | TEXT | True     | The file path the dump the audit log
| -h            | --help       | None | False    | Show a help message and exit

---

### `clawback`

Functionality: Clawback a withdrawal or rekey attempt (will be prompted which one)

Usage: `cic clawback [OPTIONS]`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -db           | --db-path    | TEXT | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -f            | --filename   | TEXT | False    | The filepath to dump the spend bundle into
| -pks          | --pubkeys    | TEXT | True     | A comma separated list of pubkeys that will be signing this spend
| -h            | --help       | None | False    | Show a help message and exit

---

### `complete`

Functionality: Complete a withdrawal or rekey attempt (will be prompted which one)

Usage: `cic complete [OPTIONS]`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -db           | --db-path    | TEXT | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -f            | --filename   | TEXT | False    | The filepath to dump the spend bundle into
| -h            | --help       | None | False    | Show a help message and exit

---

### `derive_root`

Functionality: Take an existing configuration and pubkey set to derive a puzzle root

Usage: `cic derive_root [OPTIONS]`

Options:

| Short Command | Long Command         | Type    | Required | Description |
|:-------------:|:--------------------:|:-------:|:--------:|:------------|
| -c            | --configuration      | TEXT    | False    | The configuration file with which to derive the root (or the filepath to create it at if using --db-path)  [default: ./Configuration (needs derivation).txt]
| -db           | --db-path            | TEXT    | False    | The file path to the sync DB (default: ./sync (******).sqlite)
| -pks          | --pubkeys            | TEXT    | True     | A comma separated list of pubkeys that will be signing this spend
| -m            | --initial-lock-level | TEXT    | True     | The initial number of pubkeys required to do a withdrawal or standard rekey
| -n            | --maximum-lock-level | TEXT    | False    | The maximum number of pubkeys required to do a withdrawal or standard rekey
| -min          | --minimum-pks        | INTEGER | False    | The minimum number of pubkeys required to initiate a slow rekey  [default: 1]
| -va           | --validate-against   | TEXT    | False    | Specify a configuration file to check whether it matches the specified parameters
| -h            | --help               | None    | False    | Show a help message and exit

---

### `examine_spend`

Functionality: Examine an unsigned spend to see the details before you sign it

Usage: `cic examine_spend [OPTIONS] SPEND_FILE`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -h            | --help       | None | False    | Show a help message and exit

---

### `export_config`

Functionality: Export a copy of the current DB's config

Usage: `cic export_config [OPTIONS]`

Options:

| Short Command | Long Command | Type    | Required | Description |
|:-------------:|:------------:|:-------:|:--------:|:------------|
| -f            | --filename   | TEXT    | False    | The file path to export the config to (default: ./Configuration Export (******).sqlite)
| -db           | --db-path    | TEXT    | True     | The file path to initialize/find the sync database at (default: ./sync (******).sqlite)
| -p            | --public     | BOOLEAN | False    | Export the public information only (default: false)         
| -h            | --help       | None    | False    | Show a help message and exit

---

### `increase_security_level`

Functionality: Initiate an increase of the number of keys required for withdrawal

Usage: `cic increase_security_level [OPTIONS]`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -db           | --db-path    | TEXT | True     | The file path to initialize/find the sync database at (default: ./sync (******).sqlite)
| -pks          | --pubkeys    | TEXT | True     | A comma separated list of pubkeys that will be signing this spend
| -f            | --filename   | TEXT | False    | The filepath to dump the spend bundle into
| -h            | --help       | None | False    | Show a help message and exit

---

### `init`

Functionality: Create a configuration file for the prefarm. The arguments from this command will be committed to **forever**.

Usage: `cic init [OPTIONS]`

Options:

| Short Command | Long Command          | Type | Required | Description |
|:-------------:|:---------------------:|:----:|:--------:|:------------|
| -d            | --directory           | TEXT | False    | The directory in which to create the configuration file  [default: .]
| -d            | --date                | TEXT | True     | Unix time at which withdrawals become possible [todo there are 2 -ds]
| -r            | --rate                | TEXT | True     | Mojos that can be withdrawn per second
| -a            | --amount              | TEXT | True     | The initial amount that will be locked in this custody program (in mojos)
| -wt           | --withdrawal-timelock | TEXT | True     | The amount of time where nothing has happened before a withdrawal can be made (in seconds)
| -pc           | --payment-clawback    | TEXT | True     | The amount of time to clawback a payment before it's completed (in seconds)
| -rc           | --rekey-cancel        | TEXT | True     | The amount of time to cancel a rekey before it's completed (in seconds)
| -rt           | --rekey-timelock      | TEXT | True     | The amount of time where nothing has happened before a standard rekey can be initiated (in seconds)
| -sp           | --slow-penalty        | TEXT | True     | The time penalty for performing a slow rekey (in seconds)
| -h            | --help                | None | False    | Show a help message and exit

---

### `launch_singleton`

Functionality: Use 1 mojo to launch the singleton that will control the funds

Note: This is one of the two commands (along with push_tx) that interacts directly with the blockchain

Usage: `cic launch_singleton [OPTIONS]`

Options:

| Short Command | Long Command      | Type    | Required | Description |
|:-------------:|:-----------------:|:-------:|:--------:|:------------|
| -c            | --configuration   | TEXT    | False    | The configuration file with which to launch the singleton
| -db           | --db-path         | TEXT    | False    | The file path to initialize the sync database at
| -wp           | --wallet-rpc-port | INTEGER | False    | Set the port where the Wallet is hosting the RPC interface. See the rpc_port under wallet in config.yaml
| -f            | --fingerprint     | INTEGER | False    | Set the fingerprint to specify which wallet to use
| -np           | --node-rpc-port   | INTEGER | False    | Set the port where the Node is hosting the RPC interface. See the rpc_port under full_node in config.yaml
|               | --fee             | INTEGER | False    | Fee to use for the launch transaction (in mojos) [default: 0]
| -h            | --help            | None    | False    | Show a help message and exit

---

### `p2_address`

Functionality: Print the address to pay to the singleton

Usage: `cic p2_address [OPTIONS]`

Options:

| Short Command | Long Command | Type | Required | Description |
|:-------------:|:------------:|:----:|:--------:|:------------|
| -db           | --db-path    | TEXT | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -p            | --prefix     | TEXT | False    | The prefix to use when encoding the address
| -h            | --help       | None | False    | Show a help message and exit

---

### `payment`

Functionality: Absorb/Withdraw money into/from the singleton

Usage: `cic payment [OPTIONS]`

Options:

| Short Command | Long Command                | Type    | Required | Description |
|:-------------:|:---------------------------:|:-------:|:--------:|:------------|
| -db           | --db-path                   | TEXT    | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -f            | --filename                  | TEXT    | False    | The filepath to dump the spend bundle into
| -pks          | --pubkeys                   | TEXT    | True     | A comma separated list of pubkeys that will be signing this spend
| -a            | --amount                    | INTEGER | False    | The outgoing amount (in mojos) to pay [default: 0]
| -t            | --recipient-address         | TEXT    | True     | The address that can claim the money after the clawback period is over (must be supplied if amount is > 0)
| -ap           | --absorb-available-payments | BOOLEAN | False    | Look for any outstanding payments to the singleton and claim them while doing this spend (adds tx cost) [default: false]
| -mc           | --maximum-extra-cost        | INTEGER | False    | The maximum extra tx cost to be taken on while absorbing payments (as an estimated percentage)  [default: 50]
| -at           | --amount-threshold          | INTEGER | False    | The minimum amount required of a payment in order for it to be absorbed  [default: 1000000000000 or 1 XCH][0 means "absorb everything"]
| -h            | --help                      | None    | False    | Show a help message and exit

---

### `push_tx`

Functionality: Push a signed spend bundle to the network

Note: This is one of the two commands (along with launch_singleton) that interacts directly with the blockchain

Usage: `cic push_tx [OPTIONS]`

Options:

| Short Command | Long Command      | Type    | Required | Description |
|:-------------:|:-----------------:|:-------:|:--------:|:------------|
| -b            | --spend-bundle    | TEXT    | True     | The signed spend bundle
| -wp           | --wallet-rpc-port | INTEGER | False    | Set the port where the Wallet is hosting the RPC interface. See the rpc_port under wallet in config.yaml
| -f            | --fingerprint     | INTEGER | False    | Set the fingerprint to specify which wallet to use
| -np           | --node-rpc-port   | INTEGER | False    | Set the port where the Node is hosting the RPC interface. See the rpc_port under full_node in config.yaml
| -m            | --fee             | INTEGER | False    | The fee to attach to this spend (in mojos)
| -h            | --help            | None    | False    | Show a help message and exit

---

### `show`

Functionality: Show the status of the singleton, payments, and rekeys

Usage: `cic show [OPTIONS]`

Options:

| Short Command | Long Command      | Type    | Required | Description |
|:-------------:|:-----------------:|:-------:|:--------:|:------------|
| -b            | --spend-bundle    | TEXT    | True     | The signed spend bundle
| -wp           | --wallet-rpc-port | INTEGER | False    | Set the port where the Wallet is hosting the RPC interface. See the rpc_port under wallet in config.yaml
| -f            | --fingerprint     | INTEGER | False    | Set the fingerprint to specify which wallet to use
| -np           | --node-rpc-port   | INTEGER | False    | Set the port where the Node is hosting the RPC interface. See the rpc_port under full_node in config.yaml
| -m            | --fee             | INTEGER | False    | The fee to attach to this spend (in mojos)
| -h            | --help            | None    | False    | Show a help message and exit

---

### `start_rekey`

Functionality: Rekey the singleton to a new set of keys/options

Usage: `cic start_rekey [OPTIONS]`

Options:

| Short Command | Long Command        | Type | Required | Description |
|:-------------:|:-------------------:|:----:|:--------:|:------------|
| -db           | --db-path           | TEXT | True     | The file path to the sync DB (default: ./sync (******).sqlite)
| -f            | --filename          | TEXT | False    | The filepath to dump the spend bundle into
| -pks          | --pubkeys           | TEXT | True     | A comma separated list of pubkeys that will be signing this spend
| -new          | --new-configuration | TEXT | True     | The configuration you would like to rekey the singleton to
| -h            | --help              | None | False    | Show a help message and exit

---

### `sync`

Functionality: Sync a singleton from an existing configuration

Usage: `cic sync [OPTIONS]`

Options:

| Short Command | Long Command    | Type    | Required | Description |
|:-------------:|:---------------:|:-------:|:--------:|:------------|
| -c            | --configuration | TEXT    | False    | The configuration file with which to initialize a sync database (default: ./Configuration (******).txt)
| -db           | --db-path       | TEXT    | True     | The file path to initialize/find the sync database at (default: ./sync (******).sqlite)
| -np           | --node-rpc-port | INTEGER | False    | Set the port where the Node is hosting the RPC interface. See the rpc_port under full_node in config.yaml
| -s            | --show          | None    | False    | Show a summary of the singleton after sync is complete  
| -h            | --help          | None    | False    | Show a help message and exit

---

### `update_config`

Functionality: Update an outdated config in a sync DB with a new config

Usage: `cic update_config [OPTIONS]`

Options:

| Short Command | Long Command    | Type | Required | Description |
|:-------------:|:---------------:|:----:|:--------:|:------------|
| -c            | --configuration | TEXT | False    | The configuration file with which to initialize a sync database (default: ./Configuration (******).txt)
| -db           | --db-path       | TEXT | True     | The file path to initialize/find the sync database at (default: ./sync (******).sqlite)
| -h            | --help          | None | False    | Show a help message and exit

---

## HSM CLI commands and reference

These commands are to be run from inside the Hardware Security Module or "vault".

This is a physical/offline security solution for generating and signing keys.

### Commands

* [`hsmgen`](#hsmgen)
* [`hsmpk`](#hsmpk)
* [`hsms0`](#hsms)
* [`hsmmerge`](#hsmmerge)
* [`hsm_dump_sb`](#hsm_dump_sb)
* [`hsm_test_spend`](#hsm_test_spend)

### Reference 

### `hsmgen`

Functionality: Generate a secret exponent (private key)

Usage: `hsmgen`

There are no options with this command. It will simply generate and display a single secret exponent.

Example 1 (display key):
```powershell
(venv) PS C:\> hsmgen
se12celrk5asn0f3w49dxpxe5hg6sg88ezdvp89hpgdqspwj6e03yfq9e6yw4
```

Example 2 (save key to a file):
```powershell
(venv) PS C:\> hsmgen > test.se
```

---

### `hsmpk`

Functionality: Derive a public key from a secret exponent

Usage: `hsmgen <secret exponent>`

A secret exponent (required) is the only argument allowed.

Example 1 (derive and display a public key from a file containing a secret exponent):
```powershell
(venv) PS C:\> hsmpk $(cat test.se)
bls123813eh73c2cttvqytzjfnjdhnme7ah8mzsc9yzsf2y40mvhfa9rt5nha20jw50ld8h98w9u2wc0wxxl6gttqcr
```

Example 2 (calculate a public key from a file containing a secret exponent and save it to another file):
```powershell
(venv) PS C:\> hsmpk $(cat test.se) > test.pk
```

---

### `hsms`

Functionality: Manage private keys and process signing requests

Usage: `hsms0 [-h] [-c CREATE_PRIVATE_KEY] [-g GPG_ARGUMENT] path-to-private-keys`

Positional arguments:

  `path-to-private-keys`: A file containing bech32m-encoded secret exponents. If file name ends with .gpg, "gpg -d" will be invoked automatically. File is read one line at a time.

Options:

| Short Command         | Long Command                            | Type | Required | Description |
|:---------------------:|:---------------------------------------:|:----:|:--------:|:------------|
| -c CREATE_PRIVATE_KEY | --create-private-key CREATE_PRIVATE_KEY | TEXT | False    | Create keys for non-existent files
| -g GPG_ARGUMENT       | --gpg-argument GPG_ARGUMENT             | TEXT | False    | Argument to pass to gpg (besides -d)
| -h                    | --help                                  | None | False    | Show a help message and exit

This command is normally run from an HSM with a QR scanner attached.
On Linux, this command will display a QR code to the screen to be scanned.
On Windows, the QR display isn't working.

The first example will block until the scan is complete.

Example 1 (run the basic command and wait for the QR code to be scanned): 
```powershell
(venv) PS C:\> hsms .\1.se
waiting for qrint-encoded signing requests
```

The second example will not block.

Example 2 (pipe the unsigned spend bundle through hsms0, which will output a signature encoded in base-64 (it might instead be in base-10), along with a QR code (Linux only):
Mock run by just piping the output of 1.se:
```powershell
(venv) PS C:\Users\User\prefarm_test\keys_and_sb> cat .\initial_absorb.unsigned | hsms -y --nochunks .\1.se
waiting for qrint-encoded signing requests
> 5449140665451649053284096202714691505589365577374007143978191719238477924138728005883662232162434514948867447203715240045617130770165403282022693823446338843409368762077191699285534081208295847253913527216165034379061118404584995264580179968
```

---

### `hsmmerge`

Functionality: Create a signed `Spend Bundle` from `UnsignedSpends` and signatures.

Usage: `hsmmerge [-h] path-to-unsigned-spend-as-hex hex-encoded-signature [hex-encoded-signature ...]`

Positional arguments:

  path-to-unsigned-spend-as-hex: A file containing hex-encoded `UnsignedSpends`
  hex-encoded-signature: A hex-encoded signature

Optional arguments:
  -h, --help            show a help message and exit

Note that `hex-encoded-signature` is a list. To add more signatures, append more arguments.

Example (create a signed spend bundle from two signatures and output to a text file):
```powershell
(venv) PS C:\> hsmmerge .\initial_absorb.unsigned .\initial_absorb.sig .\initial_absorb_2.sig > initial_absorb.signed
```

---

### `hsm_dump_sb`

Functionality: Dump information about `Spend Bundle`

Usage: `hsm_dump_sb [-h] hex-encoded-spend-bundle-or-file`

Positional arguments:

hex-encoded-spend-bundle-or-file: A hex-encoded `Spend Bundle`. Can be a file containing the spend bundle.

Optional arguments:

 -h, --help            show a help message and exit

Example:

```powershell
(venv) PS C:\> hsm_dump_sb .\initial_absorb.signed
(spend bundle is output)
```

---

### `hsm_test_spend`

Functionality: Generate a `UnsignedSpend` test as a proof-of-concept

Usage: `hsm_test_spend [-h] path-to-public-key [path-to-public-key ...]`

Positional arguments:

  path-to-public-key: A file containing a single bech32m-encoded public key

Optional arguments:

  -h, --help          show a help message and exit

Example:

```powershell
(venv) PS C:\Users\User\Documents\Chia\prefarm_test> hsm_test_spend test.pk
(an unsigned spend is output)
```

